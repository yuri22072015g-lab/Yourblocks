<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>3D Parkour Game</title>
<style>
body { margin: 0; overflow: hidden; font-family: Arial; }
#ui{
position:absolute;
top:15px;
left:15px;
background:rgba(0,0,0,0.6);
color:white;
padding:12px 15px;
border-radius:8px;
font-size:14px;
}
</style>
</head>
<body>

<div id="ui">
WASD — движение<br>
Пробел — прыжок<br>
ПКМ — вращение камеры<br>
Колёсико — зум<br>
Красные блоки = смерть<br>
По центру безопасная дорожка
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>

<script>

// ================= SCENE =================

let scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

let camera = new THREE.PerspectiveCamera(
75,
window.innerWidth / window.innerHeight,
0.1,
2000
);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

// ================= CAMERA =================

let yawObject = new THREE.Object3D();
let pitchObject = new THREE.Object3D();
yawObject.add(pitchObject);
pitchObject.add(camera);
scene.add(yawObject);

let cameraDistance = 7;
let minDistance = 3;
let maxDistance = 15;
let firstPerson = false;

camera.position.set(0,2.5,cameraDistance);

document.addEventListener("wheel",e=>{
cameraDistance+=e.deltaY*0.01;
cameraDistance=Math.max(minDistance,Math.min(maxDistance,cameraDistance));
});

// ================= LIGHT =================

scene.add(new THREE.AmbientLight(0xffffff,0.6));
let light=new THREE.DirectionalLight(0xffffff,0.8);
light.position.set(20,30,10);
scene.add(light);

// ================= PHYSICS =================

let world=new CANNON.World();
world.gravity.set(0,-9.82,0);

let groundMat=new CANNON.Material("ground");
let playerMat=new CANNON.Material("player");

world.addContactMaterial(
new CANNON.ContactMaterial(playerMat,groundMat,{friction:0.05})
);

// ================= GROUND =================

let groundMesh=new THREE.Mesh(
new THREE.BoxGeometry(20,2,20),
new THREE.MeshStandardMaterial({color:0x444444})
);
groundMesh.position.set(0,0,10);
scene.add(groundMesh);

let groundBody=new CANNON.Body({mass:0,material:groundMat});
groundBody.addShape(new CANNON.Box(new CANNON.Vec3(10,1,10)));
groundBody.position.copy(groundMesh.position);
world.addBody(groundBody);

// ================= LEVEL 1 (КОРОЧЕ) =================

for(let i=0;i<15;i++){
let mesh=new THREE.Mesh(
new THREE.BoxGeometry(8,1,8),
new THREE.MeshStandardMaterial({color:new THREE.Color().setHSL(i/15,0.8,0.5)})
);
mesh.position.set(0,2,-i*10);
scene.add(mesh);

let body=new CANNON.Body({mass:0,material:groundMat});
body.addShape(new CANNON.Box(new CANNON.Vec3(4,0.5,4)));
body.position.copy(mesh.position);
world.addBody(body);
}

// ================= LEVEL 2 (С ЛОВУШКАМИ) =================

let deathBlocks = [];
let startZ = -160;

for(let i=0;i<20;i++){

let platform = new THREE.Mesh(
new THREE.BoxGeometry(8,1,8),
new THREE.MeshStandardMaterial({color:0x888888})
);

platform.position.set(0,2,startZ - i*10);
scene.add(platform);

let body=new CANNON.Body({mass:0,material:groundMat});
body.addShape(new CANNON.Box(new CANNON.Vec3(4,0.5,4)));
body.position.copy(platform.position);
world.addBody(body);

// === Рандомные красные блоки (кроме центра) ===

for(let x=-3;x<=3;x+=3){

if(x===0) continue; // центральная безопасная дорожка

if(Math.random() > 0.4){ // шанс появления

let deathMesh=new THREE.Mesh(
new THREE.BoxGeometry(2,1,2),
new THREE.MeshStandardMaterial({color:0xff0000})
);

deathMesh.position.set(x,3,startZ - i*10);
scene.add(deathMesh);

let deathBody=new CANNON.Body({mass:0});
deathBody.addShape(new CANNON.Box(new CANNON.Vec3(1,0.5,1)));
deathBody.position.copy(deathMesh.position);
world.addBody(deathBody);

deathBlocks.push(deathBody);

}

}

}

// ================= PLAYER =================

let playerBody=new CANNON.Body({
mass:5,
material:playerMat,
linearDamping:0.9,
fixedRotation:true
});
playerBody.addShape(new CANNON.Sphere(0.9));
playerBody.position.set(0,8,5);
world.addBody(playerBody);

let playerGroup=new THREE.Group();

let bodyMat=new THREE.MeshStandardMaterial({color:0x0066ff});
let limbMat=new THREE.MeshStandardMaterial({color:0x003399});
let headMat=new THREE.MeshStandardMaterial({color:0xffffff});

let torso=new THREE.Mesh(new THREE.BoxGeometry(1.2,2,0.8),bodyMat);
torso.position.y=1.6;
playerGroup.add(torso);

let head=new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2),headMat);
head.position.y=3;
playerGroup.add(head);

let leftLeg=new THREE.Mesh(new THREE.BoxGeometry(0.7,1.8,0.7),limbMat);
leftLeg.position.set(-0.4,0.2,0);
playerGroup.add(leftLeg);

let rightLeg=new THREE.Mesh(new THREE.BoxGeometry(0.7,1.8,0.7),limbMat);
rightLeg.position.set(0.4,0.2,0);
playerGroup.add(rightLeg);

let leftArm=new THREE.Mesh(new THREE.BoxGeometry(0.5,1.8,0.5),limbMat);
leftArm.position.set(-0.8,1.8,0);
playerGroup.add(leftArm);

let rightArm=new THREE.Mesh(new THREE.BoxGeometry(0.5,1.8,0.5),limbMat);
rightArm.position.set(0.8,1.8,0);
playerGroup.add(rightArm);

scene.add(playerGroup);

// ================= CONTROLS =================

let keys={};
document.addEventListener("keydown",e=>keys[e.code]=true);
document.addEventListener("keyup",e=>keys[e.code]=false);
document.addEventListener("contextmenu", e => e.preventDefault());

let mouseDown=false;
const cameraSpeed = 0.01;

document.addEventListener("mousedown",e=>{
if(e.button===2) mouseDown=true;
});

document.addEventListener("mouseup",e=>{
if(e.button===2) mouseDown=false;
});

document.addEventListener("mousemove",e=>{
if(!mouseDown) return;
yawObject.rotation.y-=e.movementX*cameraSpeed;
pitchObject.rotation.x-=e.movementY*cameraSpeed;
});

// ================= DEATH SYSTEM =================

let deathHeight = -20;
let spawnPosition = new CANNON.Vec3(0,8,5);

function respawn(){
playerBody.position.copy(spawnPosition);
playerBody.velocity.set(0,0,0);
yawObject.rotation.set(0,0,0);
pitchObject.rotation.set(0,0,0);
}

// ================= GAME LOOP =================

let clock=new THREE.Clock();
let walkTime=0;

function animate(){
requestAnimationFrame(animate);

let delta=clock.getDelta();
world.step(1/60,delta,3);

if(playerBody.position.y < deathHeight){
respawn();
return;
}

for(let block of deathBlocks){
if(playerBody.position.distanceTo(block.position) < 1.8){
respawn();
return;
}
}

let moveSpeed=8;

let forward=new THREE.Vector3(0,0,-1).applyQuaternion(yawObject.quaternion);
let right=new THREE.Vector3(1,0,0).applyQuaternion(yawObject.quaternion);

let moveX=0,moveZ=0;

if(keys["KeyW"]){moveX+=forward.x;moveZ+=forward.z;}
if(keys["KeyS"]){moveX-=forward.x;moveZ-=forward.z;}
if(keys["KeyA"]){moveX-=right.x;moveZ-=right.z;}
if(keys["KeyD"]){moveX+=right.x;moveZ+=right.z;}

playerBody.velocity.x=moveX*moveSpeed;
playerBody.velocity.z=moveZ*moveSpeed;

if(keys["Space"] && Math.abs(playerBody.velocity.y)<0.1){
playerBody.velocity.y=9;
}

let moving=Math.abs(moveX)>0||Math.abs(moveZ)>0;

if(moving){
walkTime+=delta*8;
let swing=Math.sin(walkTime)*0.6;
leftLeg.rotation.x=swing;
rightLeg.rotation.x=-swing;
leftArm.rotation.x=-swing;
rightArm.rotation.x=swing;
}else{
leftLeg.rotation.x=0;
rightLeg.rotation.x=0;
leftArm.rotation.x=0;
rightArm.rotation.x=0;
}

firstPerson = cameraDistance <= minDistance + 0.2;

if(firstPerson){
camera.position.set(0,3,0);
playerGroup.visible=false;
}else{
camera.position.set(0,2.5,cameraDistance);
playerGroup.visible=true;
}

playerGroup.position.copy(playerBody.position);
playerGroup.rotation.y=yawObject.rotation.y;
yawObject.position.copy(playerBody.position);

renderer.render(scene,camera);
}

animate();

</script>
</body>
</html>
