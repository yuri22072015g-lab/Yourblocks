<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Yourblocks ‚Äî –û–±–ª–∞—á–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* ... (–≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –¥–æ–±–∞–≤–∏–º —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫) ... */
        .settings-container {
            max-width: 600px;
            margin: 0 auto;
            background: #1e1e1e;
            border-radius: 20px;
            padding: 30px;
        }
        .settings-title {
            font-size: 24px;
            color: #fff;
            margin-bottom: 20px;
            text-align: center;
        }
        .danger-zone {
            border: 2px solid #ff5555;
            border-radius: 16px;
            padding: 20px;
            margin-top: 30px;
            background: rgba(255, 80, 80, 0.1);
        }
        .danger-zone h3 {
            color: #ff5555;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            color: #888;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            background: #2a2a2a;
            border: 2px solid #333;
            border-radius: 12px;
            color: white;
            font-size: 16px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #ff5555;
        }
        .delete-btn {
            background: #ff5555;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        .delete-btn:hover {
            background: #ff3333;
            transform: scale(1.02);
        }
        .delete-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        .warning-text {
            color: #ffaa00;
            font-size: 14px;
            margin-top: 10px;
        }
        .guest-warning {
            text-align: center;
            color: #888;
            padding: 40px;
            font-size: 18px;
        }
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .confirmation-box {
            background: #1e1e1e;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            text-align: center;
            border: 2px solid #ff5555;
        }
        .confirmation-box h3 {
            color: #ff5555;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .confirmation-box p {
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        .confirmation-buttons {
            display: flex;
            gap: 15px;
        }
        .confirm-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        .confirm-btn.yes {
            background: #ff5555;
            color: white;
        }
        .confirm-btn.yes:hover {
            background: #ff3333;
        }
        .confirm-btn.no {
            background: #333;
            color: white;
        }
        .confirm-btn.no:hover {
            background: #444;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <!-- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞ –∏ –∫–ª–∞–≤–∏—à -->
    <script>
        document.addEventListener('contextmenu', function(e) { e.preventDefault(); return false; });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
                return false;
            }
        });
        document.ondragstart = function() { return false; };
        document.onselectstart = function() { return false; };
    </script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">üß±</div>
            <div class="login-title">YOURBLOCKS</div>
            <div class="login-subtitle">–í–æ–π–¥–∏, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>
            <div class="login-tabs">
                <div class="login-tab active" onclick="switchLoginTab('login')">–í—Ö–æ–¥</div>
                <div class="login-tab" onclick="switchLoginTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>
            <div id="login-form" class="login-form active">
                <div class="input-group">
                    <label>üë§ –õ–æ–≥–∏–Ω</label>
                    <input type="text" id="login-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="input-group">
                    <label>üîí –ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="login-btn" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
                <button class="guest-btn" onclick="handleGuest()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ –≥–æ—Å—Ç—å</button>
                <div id="login-error" class="error-message"></div>
            </div>
            <div id="register-form" class="login-form">
                <div class="input-group">
                    <label>üë§ –õ–æ–≥–∏–Ω</label>
                    <input type="text" id="register-username" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="input-group">
                    <label>üîí –ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="register-password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="input-group">
                    <label>üîí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</label>
                    <input type="password" id="register-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="login-btn" onclick="handleRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button class="guest-btn" onclick="handleGuest()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ –≥–æ—Å—Ç—å</button>
                <div id="register-error" class="error-message"></div>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
    <div id="menu-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">YOUR<span>BLOCKS</span></div>
                <div class="user-profile">
                    <div class="user-avatar" id="sidebar-avatar">üß±</div>
                    <div class="user-info-side">
                        <div class="user-name" id="sidebar-username">–ì–æ—Å—Ç—å</div>
                        <div class="user-status" id="sidebar-status">50 <span>–ë–ª–∏–∑–∫–∏–π</span></div>
                    </div>
                </div>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="switchPage('home')">
                    <i>üè†</i>
                    <span>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</span>
                </div>
                <div class="nav-item" onclick="switchPage('profile')">
                    <i>üë§</i>
                    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                </div>
                <div class="nav-item" onclick="switchPage('avatar')">
                    <i>üé®</i>
                    <span>–ê–≤–∞—Ç–∞—Ä</span>
                </div>
                <div class="nav-item" onclick="switchPage('friends')">
                    <i>üë•</i>
                    <span>–î—Ä—É–∑—å—è</span>
                </div>
                <div class="nav-item" onclick="switchPage('settings')">
                    <i>‚öôÔ∏è</i>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">
            <span>üö™</span> –í—ã–π—Ç–∏
        </button>
        <div class="main-content">
            <div class="content-header">
                <h1 id="page-title">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h1>
                <div class="header-stats">
                    <div>üë• <span id="global-online">1</span> –æ–Ω–ª–∞–π–Ω</div>
                    <div>üéÆ <span>1</span> –∏–≥—Ä–∞</div>
                </div>
            </div>
            <div id="home-section" class="content-section active">
                <h2 style="color: #fff; margin-bottom: 30px; text-align: center;">üî• –ò–≥—Ä–∞ –¥–Ω—è</h2>
                <div class="game-card-large" onclick="selectGame()">
                    <div class="game-image-large">üèÉ‚Äç‚ôÇÔ∏è</div>
                    <div class="game-info-large">
                        <div class="game-title-large">PARKOUR MAZE</div>
                        <div class="game-description-large">–ü–∞—Ä–∫—É—Ä + –õ–∞–±–∏—Ä–∏–Ω—Ç ‚Äî –æ–±–ª–∞—á–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</div>
                        <div class="game-features">
                            <div class="feature">
                                <div class="feature-icon">üèÉ</div>
                                <div class="feature-text"><span>20</span> –ø–ª–∞—Ç—Ñ–æ—Ä–º</div>
                            </div>
                            <div class="feature">
                                <div class="feature-icon">üß±</div>
                                <div class="feature-text"><span>–ª–∞–±–∏—Ä–∏–Ω—Ç</span> —Å–ø—Ä–∞–≤–∞</div>
                            </div>
                            <div class="feature">
                                <div class="feature-icon">üåê</div>
                                <div class="feature-text"><span>–æ–±—â–∏–π</span> —Å–µ—Ä–≤–µ—Ä</div>
                            </div>
                            <div class="feature">
                                <div class="feature-icon">üë•</div>
                                <div class="feature-text"><span id="game-players">1</span> —Å–µ–π—á–∞—Å</div>
                            </div>
                        </div>
                        <div style="margin-top: 25px; color: #4CAF50; font-size: 18px;">
                            ‚≠ê 4.9 (2.5K –æ—Ç–∑—ã–≤–æ–≤)
                        </div>
                    </div>
                </div>
                <div id="selected-game-info" style="margin-top: 30px; padding: 20px; background: #1e1e1e; border-radius: 16px;">
                    <div style="display: flex; justify-content: center;">
                        <button class="play-button" style="position: static;" onclick="startGame()">‚ñ∂ –í–û–ô–¢–ò –í –ò–ì–†–£</button>
                    </div>
                </div>
            </div>
            <div id="profile-section" class="content-section">
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profile-avatar">üß±</div>
                    <div class="profile-info">
                        <h2 id="profile-username">–ì–æ—Å—Ç—å</h2>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value">50</div>
                                <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="profile-friends-count">0</div>
                                <div class="stat-label">–î—Ä—É–∑—å—è</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">567</div>
                                <div class="stat-label">–ò–≥—Ä—ã</div>
                            </div>
                        </div>
                    </div>
                </div>
                <h3 style="color: #fff; margin: 20px 0;">–ù–µ–¥–∞–≤–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                <div style="background: #1e1e1e; border-radius: 16px; padding: 20px;">
                    <p style="color: #888;">üèÜ –ü—Ä–æ–π–¥–µ–Ω –ª–∞–±–∏—Ä–∏–Ω—Ç –∑–∞ 2 –º–∏–Ω—É—Ç—ã</p>
                    <p style="color: #888;">‚≠ê –°–æ–±—Ä–∞–Ω–æ 50 –º–æ–Ω–µ—Ç –≤ –ø–∞—Ä–∫—É—Ä–µ</p>
                    <p style="color: #888;">üöÄ 100 –ø—Ä—ã–∂–∫–æ–≤ –±–µ–∑ –ø–∞–¥–µ–Ω–∏—è</p>
                </div>
            </div>
            <div id="avatar-section" class="content-section">
                <h2 style="color: #fff; margin-bottom: 20px;">–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–∞</h2>
                <div style="display: flex; gap: 30px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div class="profile-avatar-large" id="customize-avatar">üß±</div>
                    <div style="flex: 1; min-width: 200px;">
                        <p style="color: #888;">–ù–∞—Å—Ç—Ä–æ–π –≤–Ω–µ—à–Ω–æ—Å—Ç—å —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</p>
                    </div>
                </div>
                <div class="customization-grid">
                    <div class="color-section">
                        <h3>üë§ –ì–æ–ª–æ–≤–∞</h3>
                        <div class="color-picker">
                            <div class="color-option" style="background: #ffccaa;" onclick="setPartColor('head', '#ffccaa', this)"></div>
                            <div class="color-option" style="background: #8b5a2b;" onclick="setPartColor('head', '#8b5a2b', this)"></div>
                            <div class="color-option" style="background: #f5deb3;" onclick="setPartColor('head', '#f5deb3', this)"></div>
                            <div class="color-option" style="background: #d2b48c;" onclick="setPartColor('head', '#d2b48c', this)"></div>
                            <div class="color-option" style="background: #cd853f;" onclick="setPartColor('head', '#cd853f', this)"></div>
                        </div>
                    </div>
                    <div class="color-section">
                        <h3>üëï –¢–µ–ª–æ</h3>
                        <div class="color-picker">
                            <div class="color-option" style="background: #3366ff;" onclick="setPartColor('body', '#3366ff', this)"></div>
                            <div class="color-option" style="background: #ff4444;" onclick="setPartColor('body', '#ff4444', this)"></div>
                            <div class="color-option" style="background: #44ff44;" onclick="setPartColor('body', '#44ff44', this)"></div>
                            <div class="color-option" style="background: #ffff44;" onclick="setPartColor('body', '#ffff44', this)"></div>
                            <div class="color-option" style="background: #ff44ff;" onclick="setPartColor('body', '#ff44ff', this)"></div>
                        </div>
                    </div>
                    <div class="color-section">
                        <h3>ü¶µ –ù–æ–≥–∏</h3>
                        <div class="color-picker">
                            <div class="color-option" style="background: #2244aa;" onclick="setPartColor('legs', '#2244aa', this)"></div>
                            <div class="color-option" style="background: #aa2222;" onclick="setPartColor('legs', '#aa2222', this)"></div>
                            <div class="color-option" style="background: #22aa22;" onclick="setPartColor('legs', '#22aa22', this)"></div>
                            <div class="color-option" style="background: #aaaa22;" onclick="setPartColor('legs', '#aaaa22', this)"></div>
                            <div class="color-option" style="background: #aa22aa;" onclick="setPartColor('legs', '#aa22aa', this)"></div>
                        </div>
                    </div>
                    <div class="color-section">
                        <h3>ü´± –†—É–∫–∏</h3>
                        <div class="color-picker">
                            <div class="color-option" style="background: #2244aa;" onclick="setPartColor('arms', '#2244aa', this)"></div>
                            <div class="color-option" style="background: #aa2222;" onclick="setPartColor('arms', '#aa2222', this)"></div>
                            <div class="color-option" style="background: #22aa22;" onclick="setPartColor('arms', '#22aa22', this)"></div>
                            <div class="color-option" style="background: #aaaa22;" onclick="setPartColor('arms', '#aaaa22', this)"></div>
                            <div class="color-option" style="background: #aa22aa;" onclick="setPartColor('arms', '#aa22aa', this)"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="friends-section" class="content-section">
                <div style="text-align: center; padding: 50px; color: #888;">
                    <div style="font-size: 64px;">üë•</div>
                    <h3>–î—Ä—É–∑—å—è</h3>
                    <p>–í –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–µ –≤—ã –º–æ–∂–µ—Ç–µ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å –¥—Ä—É–∑–µ–π!</p>
                </div>
            </div>
            <!-- –ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
            <div id="settings-section" class="content-section">
                <div class="settings-container">
                    <h2 class="settings-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
                    <div id="account-settings-content">
                        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div id="game-container">
        <button class="game-exit-button" onclick="exitGame()">‚úï</button>
        <div class="exit-hint">–ù–∞–∂–º–∏ ESC –∏–ª–∏ ‚úï —á—Ç–æ–±—ã –≤—ã–π—Ç–∏</div>
        <div class="server-status" id="server-status">üîµ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...</div>
        <div class="players-count" id="players-count">üë• 1 –≤ –∫–æ–º–Ω–∞—Ç–µ</div>
        <div class="ground-indicator onground" id="ground-indicator">üü¢ –ù–ê –ó–ï–ú–õ–ï</div>
        <div class="jump-hint">üëÜ –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –¥–≤–∏–∂–µ–Ω–∏–µ, –ø—Ä–∞–≤–∞—è - –∫–∞–º–µ—Ä–∞ + –ø—Ä—ã–∂–æ–∫</div>

        <div id="debug-panel"></div>
        <div id="manual-connect">
            <input type="text" id="peer-id-input" placeholder="ID –¥—Ä—É–≥–∞">
            <button onclick="manualConnect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>

        <div id="mobile-controls">
            <div id="left-area"></div>
            <div id="right-area"></div>
            <div id="joystick-left">
                <div id="joystick-handle"></div>
            </div>
            <div id="jump-button">
                –ü–†–´–ñ–û–ö
            </div>
        </div>

        <div id="game-canvas"></div>
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ -->
    <div id="delete-confirm-overlay" class="confirmation-overlay">
        <div class="confirmation-box">
            <h3>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</h3>
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–≤—Å–µ–≥–¥–∞ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</p>
            <div class="confirmation-buttons">
                <button class="confirm-btn yes" id="confirm-delete-yes">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                <button class="confirm-btn no" id="confirm-delete-no">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>

    <script>
        // ==================== –ù–ê–°–¢–†–û–ô–ö–ò FIREBASE (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏) ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDummyKeyReplaceWithYourOwn",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        let database = null;
        let usersRef = null;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            usersRef = database.ref('users');
            console.log('Firebase –ø–æ–¥–∫–ª—é—á—ë–Ω');
        } catch (e) {
            console.warn('Firebase –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ');
        }

        // ==================== –°–ò–°–¢–ï–ú–ê –ê–ö–ö–ê–£–ù–¢–û–í (–æ–±–ª–∞—á–Ω–∞—è + –ª–æ–∫–∞–ª—å–Ω–∞—è) ====================
        let currentUser = null;
        let users = {};

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤
        try {
            const saved = localStorage.getItem('yourblocks_users');
            if (saved) users = JSON.parse(saved);
        } catch (e) {}

        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ + Firebase)
        function saveUsers() {
            localStorage.setItem('yourblocks_users', JSON.stringify(users));
            if (database && usersRef) {
                usersRef.set(users).catch(e => console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase', e));
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Firebase –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        if (database && usersRef) {
            usersRef.once('value', (snapshot) => {
                const fbUsers = snapshot.val();
                if (fbUsers) {
                    users = fbUsers;
                    localStorage.setItem('yourblocks_users', JSON.stringify(users));
                }
            });
        }

        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            document.getElementById(tab + '-form').classList.add('active');
        }

        function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorDiv = document.getElementById('login-error');
            if (!username || !password) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorDiv.style.display = 'block';
                return;
            }
            if (!users[username]) {
                errorDiv.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                errorDiv.style.display = 'block';
                return;
            }
            if (users[username].password !== password) {
                errorDiv.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                errorDiv.style.display = 'block';
                return;
            }
            currentUser = { username: username, ...users[username] };
            loginSuccess();
        }

        function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const confirm = document.getElementById('register-confirm').value.trim();
            const errorDiv = document.getElementById('register-error');
            if (!username || !password || !confirm) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorDiv.style.display = 'block';
                return;
            }
            if (password !== confirm) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                errorDiv.style.display = 'block';
                return;
            }
            if (password.length < 3) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                errorDiv.style.display = 'block';
                return;
            }
            if (users[username]) {
                errorDiv.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                errorDiv.style.display = 'block';
                return;
            }
            const newUser = {
                password: password,
                level: 1,
                games: 0,
                created: Date.now(),
                colors: {
                    head: '#ffccaa',
                    body: '#3366ff',
                    legs: '#2244aa',
                    arms: '#2244aa'
                },
                friends: {},
                friendRequests: {}
            };
            users[username] = newUser;
            saveUsers();
            currentUser = { username: username, ...newUser };
            loginSuccess();
        }

        function handleGuest() {
            currentUser = {
                username: '–ì–æ—Å—Ç—å_' + Math.floor(Math.random() * 10000),
                level: 1,
                games: 0,
                isGuest: true
            };
            loginSuccess();
        }

        function loginSuccess() {
            document.getElementById('sidebar-username').textContent = currentUser.username;
            document.getElementById('profile-username').textContent = currentUser.username;
            if (currentUser.isGuest) {
                document.getElementById('sidebar-status').innerHTML = 'üë§ <span>–ì–æ—Å—Ç—å</span>';
            } else {
                document.getElementById('sidebar-status').innerHTML = currentUser.level + ' <span>–ë–ª–∏–∑–∫–∏–π</span>';
                document.getElementById('profile-friends-count').textContent = currentUser.friends ? Object.keys(currentUser.friends).length : 0;
            }
            if (currentUser.colors) {
                playerColors = currentUser.colors;
                updateAllAvatars();
            }
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('menu-container').style.display = 'flex';
                updateSettingsUI(); // –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫
            }, 500);
        }

        function logout() {
            if (!currentUser.isGuest && currentUser.username) {
                users[currentUser.username].colors = playerColors;
                saveUsers();
            }
            currentUser = null;
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-screen').style.opacity = '1';
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('register-username').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-confirm').value = '';
        }

        // ==================== –£–î–ê–õ–ï–ù–ò–ï –ê–ö–ö–ê–£–ù–¢–ê ====================
        function updateSettingsUI() {
            const container = document.getElementById('account-settings-content');
            if (!currentUser || currentUser.isGuest) {
                container.innerHTML = '<div class="guest-warning">üë§ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.</div>';
                return;
            }
            container.innerHTML = `
                <div class="danger-zone">
                    <h3>üö® –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h3>
                    <div class="input-group">
                        <label>üîí –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</label>
                        <input type="password" id="delete-password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
                    </div>
                    <button class="delete-btn" id="delete-account-btn">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –Ω–∞–≤—Å–µ–≥–¥–∞</button>
                    <div class="warning-text">–í–Ω–∏–º–∞–Ω–∏–µ! –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–µ–Ω—ã.</div>
                </div>
            `;
            document.getElementById('delete-account-btn').addEventListener('click', initiateDeleteAccount);
        }

        function initiateDeleteAccount() {
            const passwordInput = document.getElementById('delete-password');
            if (!passwordInput) return;
            const password = passwordInput.value.trim();
            if (!password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
            if (users[currentUser.username].password !== password) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                return;
            }
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            if (confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                // –í—Ç–æ—Ä–æ–π –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                if (confirm('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ! –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã. –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?')) {
                    deleteAccount();
                }
            }
        }

        function deleteAccount() {
            if (!currentUser || currentUser.isGuest) return;
            const username = currentUser.username;
            // –£–¥–∞–ª—è–µ–º –∏–∑ –æ–±—ä–µ–∫—Ç–∞ users
            delete users[username];
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            saveUsers();
            // –í—ã—Ö–æ–¥–∏–º –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            logout();
            alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω.');
        }

        // ==================== –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø ====================
        let playerColors = {
            head: '#ffccaa',
            body: '#3366ff',
            legs: '#2244aa',
            arms: '#2244aa'
        };

        function setPartColor(part, color, element) {
            playerColors[part] = color;
            const parentPicker = element.parentNode;
            Array.from(parentPicker.children).forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            updateAllAvatars();
            if (currentUser && !currentUser.isGuest) {
                users[currentUser.username].colors = playerColors;
                saveUsers();
            }
        }

        function updateAllAvatars() {
            const avatars = document.querySelectorAll('#sidebar-avatar, #profile-avatar, #customize-avatar');
            avatars.forEach(avatar => {
                avatar.style.backgroundColor = playerColors.body;
                avatar.style.color = 'white';
            });
        }

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–†–ê–ù–ò–¶–ê–ú–ò ====================
        let currentPage = 'home';

        function switchPage(page) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const titles = {
                'home': '–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞',
                'profile': '–ü—Ä–æ—Ñ–∏–ª—å',
                'avatar': '–ê–≤–∞—Ç–∞—Ä',
                'friends': '–î—Ä—É–∑—å—è',
                'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'
            };
            document.getElementById('page-title').textContent = titles[page];
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById(page + '-section').classList.add('active');
            if (page === 'settings') {
                updateSettingsUI();
            }
            currentPage = page;
        }

        function selectGame() {
            document.querySelector('.game-card-large').classList.add('selected');
        }

        // ==================== –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† (PEERJS) ====================
        let peer = null;
        let connections = new Map();
        let otherPlayers = new Map();
        let myPeerId = null;
        const ROOM_ID = 'yourblocks_global_room';

        function debugLog(msg) {
            console.log('[MULTIPLAYER]', msg);
            const panel = document.getElementById('debug-panel');
            panel.style.display = 'block';
            panel.innerHTML = msg;
            setTimeout(() => { panel.style.display = 'none'; }, 5000);
        }

        function initMultiplayer() {
            return new Promise((resolve) => {
                try {
                    peer = new Peer(ROOM_ID, {
                        host: '0.peerjs.com',
                        port: 443,
                        secure: true,
                        debug: 2
                    });

                    peer.on('open', (id) => {
                        myPeerId = id;
                        debugLog(`‚úÖ –Ø —Ö–æ—Å—Ç, ID: ${id}`);
                        document.getElementById('server-status').textContent = 'üü¢ –•–û–°–¢ –ö–û–ú–ù–ê–¢–´';
                        document.getElementById('manual-connect').style.display = 'flex';
                        document.getElementById('peer-id-input').placeholder = 'ID –¥—Ä—É–≥–∞';
                        peer.on('connection', (conn) => handleConnection(conn));
                        resolve();
                    });

                    peer.on('error', (err) => {
                        console.error('PeerJS error:', err);
                        if (err.type === 'unavailable-id') {
                            debugLog('üü° –ö–æ–º–Ω–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞, –ø–æ–¥–∫–ª—é—á–∞—é—Å—å –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç...');
                            peer = new Peer({
                                host: '0.peerjs.com',
                                port: 443,
                                secure: true,
                                debug: 2
                            });
                            peer.on('open', (id) => {
                                myPeerId = id;
                                debugLog(`‚úÖ –Ø –∫–ª–∏–µ–Ω—Ç, –º–æ–π ID: ${id}`);
                                document.getElementById('server-status').textContent = 'üü¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ö–û–ú–ù–ê–¢–ï...';
                                const conn = peer.connect(ROOM_ID);
                                if (conn) handleConnection(conn);
                                peer.on('connection', (conn) => handleConnection(conn));
                                document.getElementById('manual-connect').style.display = 'flex';
                                resolve();
                            });
                            peer.on('error', (e) => {
                                debugLog('‚ùå –û—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞: ' + e);
                                resolve();
                            });
                        } else {
                            debugLog('‚ùå –û—à–∏–±–∫–∞ PeerJS: ' + err.type);
                            document.getElementById('server-status').textContent = 'üî¥ –û–§–§–õ–ê–ô–ù';
                            resolve();
                        }
                    });
                } catch (e) {
                    debugLog('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + e);
                    resolve();
                }
            });
        }

        function handleConnection(conn) {
            const peerId = conn.peer;
            debugLog(`üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerId}`);
            conn.on('open', () => {
                debugLog(`‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å ${peerId}`);
                connections.set(peerId, conn);
                updatePlayersCount();
                sendMyInfo(conn);
                conn.on('data', (data) => handleData(peerId, data));
                conn.on('close', () => {
                    debugLog(`üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ —Å ${peerId}`);
                    connections.delete(peerId);
                    removeOtherPlayer(peerId);
                    updatePlayersCount();
                });
            });
        }

        function sendMyInfo(conn) {
            if (!localPlayerBody) return;
            conn.send({
                type: 'init',
                username: currentUser ? currentUser.username : '–ò–≥—Ä–æ–∫',
                x: localPlayerBody.position.x,
                y: localPlayerBody.position.y,
                z: localPlayerBody.position.z,
                headColor: playerColors.head,
                bodyColor: playerColors.body,
                legsColor: playerColors.legs,
                armsColor: playerColors.arms
            });
        }

        function handleData(peerId, data) {
            if (data.type === 'init') {
                if (!otherPlayers.has(peerId)) {
                    const model = createMultiplayerModel(data);
                    if (model && scene) {
                        model.position.set(data.x, data.y, data.z);
                        scene.add(model);
                        otherPlayers.set(peerId, {
                            model: model,
                            targetPos: new THREE.Vector3(data.x, data.y, data.z),
                            username: data.username
                        });
                        debugLog(`üë§ –î–æ–±–∞–≤–ª–µ–Ω –∏–≥—Ä–æ–∫ ${data.username}`);
                        updatePlayersCount();
                    }
                }
            } else if (data.type === 'position') {
                if (otherPlayers.has(peerId)) {
                    const player = otherPlayers.get(peerId);
                    player.targetPos.set(data.x, data.y, data.z);
                }
            }
        }

        function broadcastPosition() {
            if (!localPlayerBody || connections.size === 0) return;
            const data = {
                type: 'position',
                x: localPlayerBody.position.x,
                y: localPlayerBody.position.y,
                z: localPlayerBody.position.z
            };
            connections.forEach((conn) => {
                if (conn.open) conn.send(data);
            });
        }

        function removeOtherPlayer(id) {
            if (otherPlayers.has(id)) {
                const player = otherPlayers.get(id);
                if (player.model && scene) scene.remove(player.model);
                otherPlayers.delete(id);
                updatePlayersCount();
            }
        }

        function updatePlayersCount() {
            const count = otherPlayers.size + 1;
            document.getElementById('players-count').textContent = `üë• ${count} –≤ –∫–æ–º–Ω–∞—Ç–µ`;
            document.getElementById('global-online').textContent = count;
            document.getElementById('game-players').textContent = count;
        }

        function createMultiplayerModel(data) {
            try {
                const group = new THREE.Group();
                function getMaterial(hex) { return new THREE.MeshStandardMaterial({ color: hex }); }
                const torso = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2, 0.8), getMaterial(data.bodyColor));
                torso.position.y = 1.6; torso.castShadow = true; group.add(torso);
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), getMaterial(data.headColor));
                head.position.y = 3; head.castShadow = true; group.add(head);
                const leftLeg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.8, 0.7), getMaterial(data.legsColor));
                leftLeg.position.set(-0.4, 0.2, 0); leftLeg.castShadow = true; group.add(leftLeg);
                const rightLeg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.8, 0.7), getMaterial(data.legsColor));
                rightLeg.position.set(0.4, 0.2, 0); rightLeg.castShadow = true; group.add(rightLeg);
                const leftArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.8, 0.5), getMaterial(data.armsColor));
                leftArm.position.set(-0.8, 1.8, 0); leftArm.castShadow = true; group.add(leftArm);
                const rightArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.8, 0.5), getMaterial(data.armsColor));
                rightArm.position.set(0.8, 1.8, 0); rightArm.castShadow = true; group.add(rightArm);
                return group;
            } catch (e) { return null; }
        }

        function manualConnect() {
            const targetId = document.getElementById('peer-id-input').value.trim();
            if (!targetId || !peer) return;
            debugLog(`üîÑ –†—É—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${targetId}`);
            const conn = peer.connect(targetId);
            if (conn) handleConnection(conn);
            else debugLog('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
        }

        // ==================== –û–°–ù–û–í–ù–ê–Ø –ò–ì–†–ê ====================
        let scene, camera, renderer, yawObject, pitchObject, world;
        let localPlayerBody, localModel;
        let keys = {}, jumpPressed = false, spaceKeyDown = false;
        let deathBlocks = [];
        let walkTime = 0;
        let joystickActive = false;
        let joystickVector = { x: 0, y: 0 };
        let jumpButtonPressed = false;
        let cameraTouchActive = false;
        let lastTouchX = 0, lastTouchY = 0;

        function animatePlayer(model, walkTimeVal, isMoving) {
            if (!model || model.children.length < 6) return;
            const leftLeg = model.children[2];
            const rightLeg = model.children[3];
            const leftArm = model.children[4];
            const rightArm = model.children[5];
            if (isMoving) {
                const swing = Math.sin(walkTimeVal) * 0.7;
                leftLeg.rotation.x = swing;
                rightLeg.rotation.x = -swing;
                leftArm.rotation.x = -swing;
                rightArm.rotation.x = swing;
            } else {
                leftLeg.rotation.x = 0;
                rightLeg.rotation.x = 0;
                leftArm.rotation.x = 0;
                rightArm.rotation.x = 0;
            }
        }

        function createCustomPlayerModel() {
            const group = new THREE.Group();
            function getMaterial(hex) { return new THREE.MeshStandardMaterial({ color: hex }); }
            const torso = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2, 0.8), getMaterial(playerColors.body));
            torso.position.y = 1.6; torso.castShadow = true; group.add(torso);
            const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), getMaterial(playerColors.head));
            head.position.y = 3; head.castShadow = true; group.add(head);
            const leftLeg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.8, 0.7), getMaterial(playerColors.legs));
            leftLeg.position.set(-0.4, 0.2, 0); leftLeg.castShadow = true; group.add(leftLeg);
            const rightLeg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.8, 0.7), getMaterial(playerColors.legs));
            rightLeg.position.set(0.4, 0.2, 0); rightLeg.castShadow = true; group.add(rightLeg);
            const leftArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.8, 0.5), getMaterial(playerColors.arms));
            leftArm.position.set(-0.8, 1.8, 0); leftArm.castShadow = true; group.add(leftArm);
            const rightArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.8, 0.5), getMaterial(playerColors.arms));
            rightArm.position.set(0.8, 1.8, 0); rightArm.castShadow = true; group.add(rightArm);
            return group;
        }

        function isOnGround() {
            return Math.abs(localPlayerBody.velocity.y) < 0.1;
        }

        function initThreeJSGame(container) {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            yawObject = new THREE.Object3D();
            pitchObject = new THREE.Object3D();
            yawObject.add(pitchObject);
            pitchObject.add(camera);
            scene.add(yawObject);
            let cameraDistance = 8;
            camera.position.set(0, 3, cameraDistance);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
            dirLight.position.set(20, 30, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            world = new CANNON.World();
            world.gravity.set(0, -9.82, 0);
            const groundMaterial = new CANNON.Material("groundMaterial");
            const playerMaterial = new CANNON.Material("playerMaterial");
            const contactMaterial = new CANNON.ContactMaterial(playerMaterial, groundMaterial, { friction: 0.0, restitution: 0.0 });
            world.addContactMaterial(contactMaterial);
            world.defaultContactMaterial = contactMaterial;

            deathBlocks = [];

            // –£–†–û–í–ï–ù–¨
            function createLevel() {
                const groundMesh = new THREE.Mesh(
                    new THREE.BoxGeometry(80, 2, 80),
                    new THREE.MeshStandardMaterial({ color: 0x2a3a4a })
                );
                groundMesh.position.set(0, -1, 0);
                groundMesh.receiveShadow = true;
                scene.add(groundMesh);
                const groundBody = new CANNON.Body({ mass: 0, material: groundMaterial });
                groundBody.addShape(new CANNON.Box(new CANNON.Vec3(40, 1, 40)));
                groundBody.position.copy(groundMesh.position);
                world.addBody(groundBody);

                const mazeStartX = 15;
                const mazeStartZ = -20;
                const wallPositions = [
                    [mazeStartX, 2, mazeStartZ, 20, 4, 1],
                    [mazeStartX + 20, 2, mazeStartZ, 1, 4, 20],
                    [mazeStartX, 2, mazeStartZ - 10, 20, 4, 1],
                    [mazeStartX, 2, mazeStartZ + 10, 20, 4, 1],
                    [mazeStartX + 5, 2, mazeStartZ - 5, 1, 4, 8],
                    [mazeStartX + 10, 2, mazeStartZ + 2, 1, 4, 8],
                    [mazeStartX + 15, 2, mazeStartZ - 3, 1, 4, 8],
                    [mazeStartX + 8, 2, mazeStartZ + 5, 8, 4, 1],
                    [mazeStartX + 12, 2, mazeStartZ - 7, 8, 4, 1],
                ];
                wallPositions.forEach(pos => {
                    const wallMesh = new THREE.Mesh(
                        new THREE.BoxGeometry(pos[3], pos[4], pos[5]),
                        new THREE.MeshStandardMaterial({ color: 0x8B4513 })
                    );
                    wallMesh.position.set(pos[0], pos[1], pos[2]);
                    wallMesh.castShadow = true;
                    wallMesh.receiveShadow = true;
                    scene.add(wallMesh);
                    const wallBody = new CANNON.Body({ mass: 0, material: groundMaterial });
                    wallBody.addShape(new CANNON.Box(new CANNON.Vec3(pos[3]/2, pos[4]/2, pos[5]/2)));
                    wallBody.position.copy(wallMesh.position);
                    world.addBody(wallBody);
                });

                const entranceMesh = new THREE.Mesh(
                    new THREE.BoxGeometry(2, 1, 2),
                    new THREE.MeshStandardMaterial({ color: 0x4CAF50 })
                );
                entranceMesh.position.set(mazeStartX + 2, 0.5, mazeStartZ - 5);
                entranceMesh.castShadow = true;
                entranceMesh.receiveShadow = true;
                scene.add(entranceMesh);

                for (let i = 0; i < 5; i++) {
                    const deathMesh = new THREE.Mesh(
                        new THREE.BoxGeometry(1.5, 0.5, 1.5),
                        new THREE.MeshStandardMaterial({ color: 0xff3333, emissive: 0x330000 })
                    );
                    deathMesh.position.set(mazeStartX + 5 + i*3, 0.5, mazeStartZ - 2);
                    deathMesh.castShadow = true;
                    deathMesh.receiveShadow = true;
                    scene.add(deathMesh);
                    const deathBody = new CANNON.Body({ mass: 0, material: groundMaterial, collisionResponse: false });
                    deathBody.addShape(new CANNON.Box(new CANNON.Vec3(0.75, 0.25, 0.75)));
                    deathBody.position.copy(deathMesh.position);
                    world.addBody(deathBody);
                    deathBlocks.push(deathBody);
                }

                for (let i = 0; i < 20; i++) {
                    const platformMesh = new THREE.Mesh(
                        new THREE.BoxGeometry(3, 0.5, 3),
                        new THREE.MeshStandardMaterial({ color: new THREE.Color().setHSL(i / 20, 0.8, 0.5) })
                    );
                    let x, z;
                    if (i < 10) {
                        x = -10;
                        z = -10 - i * 6;
                    } else {
                        x = -15 + Math.sin(i) * 8;
                        z = -70 - (i-10) * 5;
                    }
                    platformMesh.position.set(x, 1 + i * 1.5, z);
                    platformMesh.castShadow = true;
                    platformMesh.receiveShadow = true;
                    scene.add(platformMesh);
                    const platformBody = new CANNON.Body({ mass: 0, material: groundMaterial });
                    platformBody.addShape(new CANNON.Box(new CANNON.Vec3(1.5, 0.25, 1.5)));
                    platformBody.position.copy(platformMesh.position);
                    world.addBody(platformBody);
                    if (i % 3 === 0 && i > 5) {
                        const deathMesh = new THREE.Mesh(
                            new THREE.BoxGeometry(1.2, 0.5, 1.2),
                            new THREE.MeshStandardMaterial({ color: 0xff3333, emissive: 0x330000 })
                        );
                        deathMesh.position.set(platformMesh.position.x + 1, 1.8, platformMesh.position.z);
                        deathMesh.castShadow = true;
                        deathMesh.receiveShadow = true;
                        scene.add(deathMesh);
                        const deathBody = new CANNON.Body({ mass: 0, material: groundMaterial, collisionResponse: false });
                        deathBody.addShape(new CANNON.Box(new CANNON.Vec3(0.6, 0.25, 0.6)));
                        deathBody.position.copy(deathMesh.position);
                        world.addBody(deathBody);
                        deathBlocks.push(deathBody);
                    }
                }

                const finishMesh = new THREE.Mesh(
                    new THREE.BoxGeometry(5, 0.5, 5),
                    new THREE.MeshStandardMaterial({ color: 0xffaa00, emissive: 0x442200 })
                );
                finishMesh.position.set(0, 0.5, -150);
                finishMesh.castShadow = true;
                finishMesh.receiveShadow = true;
                scene.add(finishMesh);
            }

            createLevel();

            localPlayerBody = new CANNON.Body({
                mass: 5,
                material: playerMaterial,
                linearDamping: 0.0,
                angularDamping: 0.0,
                fixedRotation: true
            });
            localPlayerBody.addShape(new CANNON.Sphere(0.9));
            localPlayerBody.position.set(0, 5, 10);
            world.addBody(localPlayerBody);

            localModel = createCustomPlayerModel();
            scene.add(localModel);

            // –£–ü–†–ê–í–õ–ï–ù–ò–ï
            keys = {};
            jumpPressed = false;
            spaceKeyDown = false;

            document.addEventListener("keydown", (e) => {
                keys[e.code] = true;
                if (e.code === "Space" && !spaceKeyDown) {
                    jumpPressed = true;
                    spaceKeyDown = true;
                }
            });
            document.addEventListener("keyup", (e) => {
                keys[e.code] = false;
                if (e.code === "Space") {
                    spaceKeyDown = false;
                }
            });

            let mouseDown = false;
            document.addEventListener("mousedown", (e) => {
                if (e.button === 2) mouseDown = true;
            });
            document.addEventListener("mouseup", (e) => {
                if (e.button === 2) mouseDown = false;
            });
            document.addEventListener("mousemove", (e) => {
                if (!mouseDown) return;
                yawObject.rotation.y -= e.movementX * 0.002;
                pitchObject.rotation.x -= e.movementY * 0.002;
                pitchObject.rotation.x = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, pitchObject.rotation.x));
            });

            const spawnPosition = new CANNON.Vec3(0, 5, 10);
            const deathHeight = -10;
            const groundIndicator = document.getElementById('ground-indicator');

            walkTime = 0;
            let lastSendTime = 0;

            function animate() {
                requestAnimationFrame(animate);
                const delta = 0.016;
                world.step(1 / 60, delta, 3);

                let dead = false;
                if (localPlayerBody.position.y < deathHeight) dead = true;
                if (!dead) {
                    const playerPos = localPlayerBody.position;
                    const playerRadius = 0.9;
                    for (let block of deathBlocks) {
                        const blockPos = block.position;
                        const dx = playerPos.x - blockPos.x;
                        const dy = playerPos.y - blockPos.y;
                        const dz = playerPos.z - blockPos.z;
                        const distance = Math.sqrt(dx*dx + dy*dy + dz*dz);
                        if (distance < playerRadius + 1.0) { dead = true; break; }
                    }
                }
                if (dead) {
                    localPlayerBody.position.copy(spawnPosition);
                    localPlayerBody.velocity.set(0, 0, 0);
                }

                const moveSpeed = 12;
                let moveX = 0, moveZ = 0;
                if (keys["KeyW"]) moveZ += 1;
                if (keys["KeyS"]) moveZ -= 1;
                if (keys["KeyA"]) moveX -= 1;
                if (keys["KeyD"]) moveX += 1;
                if (joystickActive) {
                    moveX += joystickVector.x;
                    moveZ += -joystickVector.y;
                }
                if (moveX !== 0 || moveZ !== 0) {
                    const len = Math.sqrt(moveX*moveX + moveZ*moveZ);
                    moveX /= len; moveZ /= len;
                    localModel.rotation.y = Math.atan2(moveX, moveZ);
                }
                const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(yawObject.quaternion);
                const right = new THREE.Vector3(1, 0, 0).applyQuaternion(yawObject.quaternion);
                forward.y = 0; right.y = 0;
                forward.normalize(); right.normalize();
                localPlayerBody.velocity.x = (forward.x * moveZ + right.x * moveX) * moveSpeed;
                localPlayerBody.velocity.z = (forward.z * moveZ + right.z * moveX) * moveSpeed;

                const onGround = isOnGround();
                groundIndicator.textContent = onGround ? 'üü¢ –ù–ê –ó–ï–ú–õ–ï' : 'üî¥ –í –í–û–ó–î–£–•–ï';
                groundIndicator.classList.toggle('onground', onGround);
                groundIndicator.classList.toggle('air', !onGround);

                if ((jumpPressed || jumpButtonPressed) && onGround) {
                    localPlayerBody.velocity.y = 10;
                    jumpPressed = false;
                    jumpButtonPressed = false;
                    document.getElementById('jump-button').classList.remove('active');
                }

                const moving = Math.abs(localPlayerBody.velocity.x) > 0.1 || Math.abs(localPlayerBody.velocity.z) > 0.1;
                if (moving) walkTime += delta * 12;
                animatePlayer(localModel, walkTime, moving);

                if (connections.size > 0) {
                    const now = Date.now();
                    if (now - lastSendTime > 100) {
                        broadcastPosition();
                        lastSendTime = now;
                    }
                }

                otherPlayers.forEach((player) => {
                    if (player.model && player.targetPos) {
                        player.model.position.lerp(player.targetPos, 0.3);
                    }
                });

                camera.position.set(0, 3, cameraDistance);
                localModel.position.copy(localPlayerBody.position);
                yawObject.position.copy(localPlayerBody.position);

                renderer.render(scene, camera);
            }

            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ==================== –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
        function initMobileControls() {
            const leftArea = document.getElementById('left-area');
            const rightArea = document.getElementById('right-area');
            const joystick = document.getElementById('joystick-left');
            const handle = document.getElementById('joystick-handle');
            const jumpBtn = document.getElementById('jump-button');

            leftArea.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                updateJoystick(e.touches[0]);
            });
            leftArea.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) updateJoystick(e.touches[0]);
            });
            leftArea.addEventListener('touchend', (e) => {
                e.preventDefault();
                joystickActive = false;
                joystickVector = { x: 0, y: 0 };
                handle.style.transform = 'translate(0px, 0px)';
            });

            function updateJoystick(touch) {
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                let dx = touch.clientX - centerX;
                let dy = touch.clientY - centerY;
                const distance = Math.sqrt(dx*dx + dy*dy);
                const maxDistance = rect.width / 2;
                if (distance > maxDistance) {
                    dx = (dx / distance) * maxDistance;
                    dy = (dy / distance) * maxDistance;
                }
                handle.style.transform = `translate(${dx}px, ${dy}px)`;
                joystickVector.x = dx / maxDistance;
                joystickVector.y = dy / maxDistance;
            }

            rightArea.addEventListener('touchstart', (e) => {
                e.preventDefault();
                cameraTouchActive = true;
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
            });
            rightArea.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (cameraTouchActive && yawObject) {
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - lastTouchX;
                    const deltaY = touch.clientY - lastTouchY;
                    yawObject.rotation.y -= deltaX * 0.005;
                    if (pitchObject) {
                        pitchObject.rotation.x -= deltaY * 0.003;
                        pitchObject.rotation.x = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, pitchObject.rotation.x));
                    }
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                }
            });
            rightArea.addEventListener('touchend', (e) => {
                e.preventDefault();
                cameraTouchActive = false;
            });

            jumpBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                jumpButtonPressed = true;
                jumpBtn.classList.add('active');
            });
            jumpBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                jumpButtonPressed = false;
                jumpBtn.classList.remove('active');
            });
        }

        async function startGame() {
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('game-container').classList.add('active');
            if (window.innerWidth <= 768) document.getElementById('mobile-controls').classList.add('active');

            await initMultiplayer();

            initThreeJSGame(document.getElementById('game-canvas'));
            initMobileControls();
        }

        function exitGame() {
            if (peer) peer.destroy();
            document.getElementById('menu-container').style.display = 'flex';
            document.getElementById('game-container').classList.remove('active');
            document.getElementById('mobile-controls').classList.remove('active');
            document.getElementById('game-canvas').innerHTML = '';
            document.getElementById('manual-connect').style.display = 'none';
            if (window.gameAnimation) {
                cancelAnimationFrame(window.gameAnimation);
                window.gameAnimation = null;
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const gameContainer = document.getElementById('game-container');
                if (gameContainer.classList.contains('active')) exitGame();
            }
        });
    </script>
</body>
</html>
