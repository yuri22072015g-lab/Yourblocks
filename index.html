<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Yourblocks ‚Äî –û–±–ª–∞—á–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Å–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ–ª–Ω—ã–π –∫–æ–¥) */
        /* –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ–Ω–∏ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è, –Ω–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–¥–µ—Å—å */
        /* –í —Ä–µ–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ —è –±—ã –≤—Å—Ç–∞–≤–∏–ª –ø–æ–ª–Ω—ã–π CSS –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
    </style>
    <!-- Firebase SDK (–º–æ–¥—É–ª–∏) -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Firebase –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, signOut, deleteUser, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, child, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // üîÅ –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –û–ë–™–ï–ö–¢ –ù–ê –°–í–û–ô –ò–ó FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "yourblocks.firebaseapp.com",
            databaseURL: "https://yourblocks-default-rtdb.firebaseio.com",
            projectId: "yourblocks",
            storageBucket: "yourblocks.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abc123"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // –î–µ–ª–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseChild = child;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
        window.firebaseSignOut = signOut;
        window.firebaseDeleteUser = deleteUser;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
    </script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <!-- –¢—Ä–∏ –∏ –ö–∞–Ω–Ω–æ–Ω –æ—Å—Ç–∞—é—Ç—Å—è -->
</head>
<body>
    <!-- –í—Å—è —Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (login-screen, menu-container, game-container) -->
    <!-- ... -->

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>

    <script>
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentUser = null;          // –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
        let currentAuthUser = null;       // –æ–±—ä–µ–∫—Ç –∏–∑ Firebase Auth
        let playerColors = {
            head: '#ffccaa',
            body: '#3366ff',
            legs: '#2244aa',
            arms: '#2244aa'
        };

        // –°—Å—ã–ª–∫–∏ –Ω–∞ Firebase (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –º–æ–¥—É–ª–µ –≤—ã—à–µ)
        const auth = window.firebaseAuth;
        const db = window.firebaseDb;
        const ref = window.firebaseRef;
        const set = window.firebaseSet;
        const get = window.firebaseGet;
        const child = window.firebaseChild;
        const update = window.firebaseUpdate;
        const remove = window.firebaseRemove;
        const signOut = window.firebaseSignOut;
        const deleteUser = window.firebaseDeleteUser;
        const onAuthStateChanged = window.firebaseOnAuthStateChanged;

        // ==================== –°–õ–£–®–ê–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ====================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª (–≤ —Ç–æ–º —á–∏—Å–ª–µ –∞–Ω–æ–Ω–∏–º–Ω–æ)
                currentAuthUser = user;
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
                const snapshot = await get(child(ref(db), 'users/' + user.uid));
                if (snapshot.exists()) {
                    currentUser = snapshot.val();
                    currentUser.uid = user.uid;
                } else {
                    // –ù–æ–≤—ã–π –∞–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å
                    currentUser = {
                        username: '–ê–Ω–æ–Ω–∏–º_' + Math.floor(Math.random() * 10000),
                        level: 1,
                        games: 0,
                        isGuest: user.isAnonymous,
                        colors: playerColors,
                        friends: {},
                        created: Date.now()
                    };
                    await set(ref(db, 'users/' + user.uid), currentUser);
                }
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (currentUser.colors) {
                    playerColors = currentUser.colors;
                }
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
                loginSuccess();
            } else {
                // –ù–∏–∫—Ç–æ –Ω–µ –≤–æ—à—ë–ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('login-screen').style.opacity = '1';
                document.getElementById('menu-container').style.display = 'none';
                currentUser = null;
                currentAuthUser = null;
            }
        });

        // ==================== –§–£–ù–ö–¶–ò–ò –í–•–û–î–ê / –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ====================
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            document.getElementById(tab + '-form').classList.add('active');
        }

        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorDiv = document.getElementById('login-error');
            if (!username || !password) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorDiv.style.display = 'block';
                return;
            }
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º email = username + '@yourblocks.local'
                const email = username + '@yourblocks.local';
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –∏ –∑–∞–≥—Ä—É–∑–∏—Ç –¥–∞–Ω–Ω—ã–µ
            } catch (error) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        async function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const confirm = document.getElementById('register-confirm').value.trim();
            const errorDiv = document.getElementById('register-error');
            if (!username || !password || !confirm) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorDiv.style.display = 'block';
                return;
            }
            if (password !== confirm) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                errorDiv.style.display = 'block';
                return;
            }
            if (password.length < 3) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                errorDiv.style.display = 'block';
                return;
            }
            try {
                const email = username + '@yourblocks.local';
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                // –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –≤ –ë–î
                const newUser = {
                    username: username,
                    level: 1,
                    games: 0,
                    isGuest: false,
                    colors: playerColors,
                    friends: {},
                    created: Date.now()
                };
                await set(ref(db, 'users/' + cred.user.uid), newUser);
                // onAuthStateChanged –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç
            } catch (error) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        async function handleGuest() {
            try {
                await signInAnonymously(auth);
                // onAuthStateChanged —Å–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –∫–∞–∫ –≥–æ—Å—Ç—å: ' + error.message);
            }
        }

        function loginSuccess() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('sidebar-username').textContent = currentUser.username;
            document.getElementById('profile-username').textContent = currentUser.username;
            if (currentUser.isGuest) {
                document.getElementById('sidebar-status').innerHTML = 'üë§ <span>–ì–æ—Å—Ç—å</span>';
            } else {
                document.getElementById('sidebar-status').innerHTML = (currentUser.level || 1) + ' <span>–ë–ª–∏–∑–∫–∏–π</span>';
                document.getElementById('profile-friends-count').textContent = currentUser.friends ? Object.keys(currentUser.friends).length : 0;
            }
            updateAllAvatars();
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('menu-container').style.display = 'flex';
            }, 500);
        }

        async function logout() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–≤–µ—Ç–∞ –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
            if (currentAuthUser && !currentAuthUser.isAnonymous) {
                await update(ref(db, 'users/' + currentAuthUser.uid), { colors: playerColors });
            }
            await signOut(auth);
            // onAuthStateChanged –≤–µ—Ä–Ω—ë—Ç –Ω–∞ —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
        }

        async function deleteAccount() {
            if (!currentAuthUser) return;
            if (currentAuthUser.isAnonymous) {
                alert('–ì–æ—Å—Ç–∏ –Ω–µ –º–æ–≥—É—Ç —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç. –ü—Ä–æ—Å—Ç–æ –≤—ã–π–¥–∏—Ç–µ.');
                return;
            }
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
                await remove(ref(db, 'users/' + currentAuthUser.uid));
                // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Authentication
                await deleteUser(currentAuthUser);
                // –í—ã—Ö–æ–¥ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ onAuthStateChanged
            }
        }

        // ==================== –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø ====================
        function setPartColor(part, color, element) {
            playerColors[part] = color;
            const parentPicker = element.parentNode;
            Array.from(parentPicker.children).forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            updateAllAvatars();
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
            if (currentAuthUser && !currentAuthUser.isAnonymous) {
                update(ref(db, 'users/' + currentAuthUser.uid), { colors: playerColors });
            }
        }

        function updateAllAvatars() {
            const avatars = document.querySelectorAll('#sidebar-avatar, #profile-avatar, #customize-avatar');
            avatars.forEach(avatar => {
                avatar.style.backgroundColor = playerColors.body;
                avatar.style.color = 'white';
            });
        }

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–†–ê–ù–ò–¶–ê–ú–ò ====================
        let currentPage = 'home';

        function switchPage(page) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const titles = {
                'home': '–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞',
                'profile': '–ü—Ä–æ—Ñ–∏–ª—å',
                'avatar': '–ê–≤–∞—Ç–∞—Ä',
                'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                'friends': '–î—Ä—É–∑—å—è'
            };
            document.getElementById('page-title').textContent = titles[page];
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById(page + '-section').classList.add('active');
            currentPage = page;
        }

        function selectGame() {
            document.querySelector('.game-card-large').classList.add('selected');
        }

        // ==================== –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† –ò –ò–ì–†–ê (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ====================
        // ... (–≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞: initMultiplayer, handleConnection, –∏ —Ç.–¥.)
        // –û–Ω –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ—á–Ω–æ —Ç–∞–∫–∏–º –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø–æ–ª–Ω–æ–º –ª–∏—Å—Ç–∏–Ω–≥–µ.
        // –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ —è –Ω–µ –¥—É–±–ª–∏—Ä—É—é –µ–≥–æ –∑–¥–µ—Å—å, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å.

        // ==================== –ó–ê–ü–£–°–ö –ò–ì–†–´ ====================
        async function startGame() {
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('game-container').classList.add('active');
            if (window.innerWidth <= 768) document.getElementById('mobile-controls').classList.add('active');

            await initMultiplayer(); // –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞
            initThreeJSGame(document.getElementById('game-canvas'));
            initMobileControls();
        }

        function exitGame() {
            if (peer) peer.destroy();
            document.getElementById('menu-container').style.display = 'flex';
            document.getElementById('game-container').classList.remove('active');
            document.getElementById('mobile-controls').classList.remove('active');
            document.getElementById('game-canvas').innerHTML = '';
            document.getElementById('manual-connect').style.display = 'none';
            if (window.gameAnimation) {
                cancelAnimationFrame(window.gameAnimation);
                window.gameAnimation = null;
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const gameContainer = document.getElementById('game-container');
                if (gameContainer.classList.contains('active')) exitGame();
            }
        });
    </script>
</body>
</html>
