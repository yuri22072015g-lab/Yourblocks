<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger MVP (–æ–¥–∏–Ω HTML)</title>
    <style>
        * { box-sizing: border-box; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; }
        body { background: #0a0f1e; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .app { width: 380px; background: #1e2a3a; border-radius: 28px; box-shadow: 0 20px 40px rgba(0,0,0,0.6); overflow: hidden; color: #e6e9ff; position: relative; }
        .screen { padding: 24px; display: none; }
        .screen.active { display: block; }
        h2 { margin: 0 0 20px; font-weight: 400; color: #a0b3d9; }
        input, button, select { width: 100%; padding: 14px; border: none; border-radius: 14px; margin: 8px 0; font-size: 16px; outline: none; }
        input, select { background: #2c3a4b; color: white; }
        input::placeholder { color: #7a8ba8; }
        button { background: #2b6c9e; color: white; font-weight: 600; cursor: pointer; transition: 0.2s; }
        button:hover { background: #1e5a8a; }
        button.danger { background: #8a3f3f; }
        button.danger:hover { background: #6f2f2f; }
        .phone-input { display: flex; gap: 8px; }
        .phone-input select { width: 90px; }
        .code-input { display: flex; gap: 8px; }
        .code-input input { flex: 1; text-align: center; letter-spacing: 4px; font-size: 20px; }
        .row { display: flex; gap: 12px; align-items: center; }
        .contact-list { list-style: none; padding: 0; margin: 20px 0; }
        .contact-list li { padding: 15px; background: #263647; border-radius: 18px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
        .contact-list li:hover { background: #2e4053; }
        .online { width: 10px; height: 10px; background: #3acb6e; border-radius: 50%; }
        .offline { width: 10px; height: 10px; background: #7f8fa0; border-radius: 50%; }
        .chat-header { display: flex; align-items: center; gap: 12px; padding-bottom: 16px; border-bottom: 1px solid #35485b; margin-bottom: 16px; }
        .chat-header .back { font-size: 24px; cursor: pointer; }
        .messages { height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; padding-right: 4px; }
        .message { max-width: 80%; padding: 10px 14px; border-radius: 18px; word-wrap: break-word; }
        .message.out { align-self: flex-end; background: #2b6c9e; color: white; }
        .message.in { align-self: flex-start; background: #2c3a4b; }
        .message small { display: block; font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right; }
        .status-icons { font-size: 14px; margin-left: 6px; }
        .input-area { display: flex; gap: 8px; }
        .input-area input { margin: 0; }
        .input-area button { width: auto; padding: 14px 20px; }
        .call-screen { background: #0f1a24; position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .call-screen.active { display: flex; }
        .call-avatar { width: 120px; height: 120px; background: #2b6c9e; border-radius: 60px; display: flex; align-items: center; justify-content: center; font-size: 48px; margin-bottom: 30px; }
        .call-status { font-size: 24px; margin-bottom: 40px; }
        .call-controls { display: flex; gap: 30px; }
        .call-btn { width: 70px; height: 70px; border-radius: 35px; background: #2c3a4b; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; }
        .call-btn.end { background: #c23b3b; }
        .incoming-call { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e2a3a; padding: 20px; border-radius: 30px; display: none; gap: 20px; z-index: 2000; box-shadow: 0 10px 20px black; }
        .incoming-call.active { display: flex; }
        .incoming-avatar { width: 50px; height: 50px; background: #2b6c9e; border-radius: 25px; display: flex; align-items: center; justify-content: center; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #263647; padding: 12px 24px; border-radius: 40px; display: none; z-index: 3000; }
    </style>
</head>
<body>
<div class="app" id="app">
    <!-- –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞) -->
    <div id="registerScreen" class="screen active">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <div class="phone-input">
            <select id="countryCode">
                <option value="+7">+7</option>
                <option value="+1">+1</option>
                <option value="+44">+44</option>
            </select>
            <input type="tel" id="phoneNumber" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
        </div>
        <button id="requestCodeBtn">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
        <div class="code-input" style="margin-top: 16px;">
            <input type="text" id="smsCode" placeholder="6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥" maxlength="6">
        </div>
        <button id="verifyCodeBtn" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <div style="margin-top: 20px; font-size: 12px; color: #7a8ba8;">*–ö–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏</div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
    <div id="contactsScreen" class="screen">
        <div class="row" style="justify-content: space-between;">
            <h2>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
            <span id="currentUserPhone" style="background: #2c3a4b; padding: 6px 12px; border-radius: 30px;"></span>
        </div>
        <ul class="contact-list" id="contactList">
            <!-- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ js -->
        </ul>
        <button id="logoutBtn">–í—ã–π—Ç–∏</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º -->
    <div id="chatScreen" class="screen">
        <div class="chat-header">
            <span class="back" id="backToContacts">‚Üê</span>
            <div>
                <div id="chatContactName"></div>
                <small id="chatContactStatus">–æ—Ñ–ª–∞–π–Ω</small>
            </div>
            <button id="callButton" style="width: auto; margin-left: auto;">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
        </div>
        <div class="messages" id="messagesContainer"></div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
            <button id="sendMessageBtn">‚û§</button>
        </div>
    </div>

    <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–≤–æ–Ω–∫–∞ (–∏—Å—Ö–æ–¥—è—â–∏–π/–∞–∫—Ç–∏–≤–Ω—ã–π) -->
    <div id="callScreen" class="call-screen">
        <div class="call-avatar" id="callAvatar">üë§</div>
        <div class="call-status" id="callStatus">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>
        <div class="call-controls">
            <div class="call-btn" id="muteMicrophoneBtn">üé§</div>
            <div class="call-btn end" id="endCallBtn">üìû</div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ -->
    <div id="incomingCall" class="incoming-call">
        <div class="incoming-avatar">üë§</div>
        <div>
            <div id="incomingCallerName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            <small>–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</small>
        </div>
        <button id="acceptCallBtn" style="width: auto; background: #3acb6e;">–ü—Ä–∏–Ω—è—Ç—å</button>
        <button id="declineCallBtn" style="width: auto; background: #c23b3b;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </div>

    <div id="toast" class="toast"></div>
</div>

<script>
    (function() {
        // ======================== –≠–º—É–ª—è—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (localStorage) ========================
        const STORAGE_KEYS = {
            users: 'messenger_users',
            currentUser: 'messenger_current_user',
            messages: 'messenger_messages',
            calls: 'messenger_calls',
            verificationCodes: 'messenger_verification_codes'
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–≤–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        if (!localStorage.getItem(STORAGE_KEYS.users)) {
            const demoUsers = [
                { id: '1', phone: '+79001234567', name: '–ê–Ω–Ω–∞', isOnline: false, lastSeen: new Date().toISOString() },
                { id: '2', phone: '+79007654321', name: '–ò–≤–∞–Ω', isOnline: false, lastSeen: new Date().toISOString() }
            ];
            localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(demoUsers));
        }
        if (!localStorage.getItem(STORAGE_KEYS.messages)) {
            localStorage.setItem(STORAGE_KEYS.messages, JSON.stringify([]));
        }
        if (!localStorage.getItem(STORAGE_KEYS.calls)) {
            localStorage.setItem(STORAGE_KEYS.calls, JSON.stringify([]));
        }
        if (!localStorage.getItem(STORAGE_KEYS.verificationCodes)) {
            localStorage.setItem(STORAGE_KEYS.verificationCodes, JSON.stringify({}));
        }

        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ localStorage)
        let currentUser = null;
        let currentContact = null;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const registerScreen = document.getElementById('registerScreen');
        const contactsScreen = document.getElementById('contactsScreen');
        const chatScreen = document.getElementById('chatScreen');
        const callScreen = document.getElementById('callScreen');
        const incomingCallDiv = document.getElementById('incomingCall');
        const toastDiv = document.getElementById('toast');

        const countryCode = document.getElementById('countryCode');
        const phoneInput = document.getElementById('phoneNumber');
        const smsCodeInput = document.getElementById('smsCode');
        const requestCodeBtn = document.getElementById('requestCodeBtn');
        const verifyCodeBtn = document.getElementById('verifyCodeBtn');

        const currentUserPhoneSpan = document.getElementById('currentUserPhone');
        const contactList = document.getElementById('contactList');
        const logoutBtn = document.getElementById('logoutBtn');

        const backToContacts = document.getElementById('backToContacts');
        const chatContactName = document.getElementById('chatContactName');
        const chatContactStatus = document.getElementById('chatContactStatus');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const callButton = document.getElementById('callButton');

        const callAvatar = document.getElementById('callAvatar');
        const callStatus = document.getElementById('callStatus');
        const muteMicrophoneBtn = document.getElementById('muteMicrophoneBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const acceptCallBtn = document.getElementById('acceptCallBtn');
        const declineCallBtn = document.getElementById('declineCallBtn');
        const incomingCallerName = document.getElementById('incomingCallerName');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        let callState = {
            active: false,
            withUserId: null,
            isMuted: false,
            isIncoming: false
        };

        // ======================== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ========================
        function showToast(text, duration = 3000) {
            toastDiv.textContent = text;
            toastDiv.style.display = 'block';
            setTimeout(() => toastDiv.style.display = 'none', duration);
        }

        function getUsers() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.users)) || [];
        }

        function saveUsers(users) {
            localStorage.setItem(STORAGE_KEYS.users, JSON.stringify(users));
            // –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫
            window.dispatchEvent(new Event('storage'));
        }

        function getMessages() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.messages)) || [];
        }

        function saveMessages(messages) {
            localStorage.setItem(STORAGE_KEYS.messages, JSON.stringify(messages));
            window.dispatchEvent(new Event('storage'));
        }

        function getVerificationCodes() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.verificationCodes)) || {};
        }

        function saveVerificationCodes(codes) {
            localStorage.setItem(STORAGE_KEYS.verificationCodes, JSON.stringify(codes));
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω
        function setUserOnline(userId, online) {
            const users = getUsers();
            const user = users.find(u => u.id === userId);
            if (user) {
                user.isOnline = online;
                user.lastSeen = new Date().toISOString();
                saveUsers(users);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
        function loadCurrentUser() {
            const saved = localStorage.getItem(STORAGE_KEYS.currentUser);
            if (saved) {
                currentUser = JSON.parse(saved);
                setUserOnline(currentUser.id, true);
                renderContactsScreen();
                switchScreen('contacts');
            } else {
                switchScreen('register');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function setCurrentUser(user) {
            currentUser = user;
            localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(user));
            setUserOnline(user.id, true);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        function switchScreen(screenName) {
            registerScreen.classList.remove('active');
            contactsScreen.classList.remove('active');
            chatScreen.classList.remove('active');
            if (screenName === 'register') registerScreen.classList.add('active');
            if (screenName === 'contacts') contactsScreen.classList.add('active');
            if (screenName === 'chat') chatScreen.classList.add('active');
        }

        // ======================== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ SMS ========================
        requestCodeBtn.addEventListener('click', () => {
            const phone = countryCode.value + phoneInput.value.trim();
            if (!phone || phone.length < 10) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä');
                return;
            }
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 6-–∑–Ω–∞—á–Ω–æ–≥–æ –∫–æ–¥–∞
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            const expires = Date.now() + 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –≤ localStorage (–∏–º–∏—Ç–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞)
            const codes = getVerificationCodes();
            codes[phone] = { code, expires };
            saveVerificationCodes(codes);

            // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è SMS: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ –≤ —Ç–æ—Å—Ç–µ
            showToast(`–í–∞—à –∫–æ–¥: ${code}`, 6000);

            smsCodeInput.disabled = false;
            verifyCodeBtn.disabled = false;
            smsCodeInput.focus();
        });

        verifyCodeBtn.addEventListener('click', () => {
            const phone = countryCode.value + phoneInput.value.trim();
            const enteredCode = smsCodeInput.value.trim();
            const codes = getVerificationCodes();
            const record = codes[phone];

            if (!record) {
                showToast('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –∫–æ–¥');
                return;
            }
            if (Date.now() > record.expires) {
                showToast('–ö–æ–¥ –∏—Å—Ç—ë–∫, –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π');
                delete codes[phone];
                saveVerificationCodes(codes);
                return;
            }
            if (enteredCode !== record.code) {
                showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
                return;
            }

            // –ö–æ–¥ –≤–µ—Ä–Ω—ã–π ‚Äî —Å–æ–∑–¥–∞—ë–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            delete codes[phone];
            saveVerificationCodes(codes);

            const users = getUsers();
            let user = users.find(u => u.phone === phone);
            if (!user) {
                // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                const newId = 'user_' + Date.now() + Math.random().toString(36);
                user = {
                    id: newId,
                    phone: phone,
                    name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + phone.slice(-4),
                    isOnline: true,
                    lastSeen: new Date().toISOString()
                };
                users.push(user);
                saveUsers(users);
            }
            setCurrentUser(user);
            showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
            switchScreen('contacts');
            renderContactsScreen();
        });

        // ======================== –ö–æ–Ω—Ç–∞–∫—Ç—ã ========================
        function renderContactsScreen() {
            if (!currentUser) return;
            currentUserPhoneSpan.textContent = currentUser.phone;
            const users = getUsers().filter(u => u.id !== currentUser.id);
            contactList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="${user.isOnline ? 'online' : 'offline'}"></span>
                    <div style="flex:1;">
                        <strong>${user.name}</strong><br>
                        <small>${user.isOnline ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª(–∞) ' + new Date(user.lastSeen).toLocaleString()}</small>
                    </div>
                `;
                li.addEventListener('click', () => openChat(user));
                contactList.appendChild(li);
            });
        }

        function openChat(contact) {
            currentContact = contact;
            chatContactName.textContent = contact.name;
            updateContactStatus(contact);
            renderMessages();
            switchScreen('chat');
        }

        function updateContactStatus(contact) {
            const user = getUsers().find(u => u.id === contact.id);
            if (user) {
                contact.isOnline = user.isOnline;
                contact.lastSeen = user.lastSeen;
                chatContactStatus.textContent = user.isOnline ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ';
            }
        }

        // ======================== –ß–∞—Ç ========================
        function renderMessages() {
            if (!currentUser || !currentContact) return;
            const messages = getMessages().filter(m => 
                (m.senderId === currentUser.id && m.receiverId === currentContact.id) ||
                (m.senderId === currentContact.id && m.receiverId === currentUser.id)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            messagesContainer.innerHTML = '';
            messages.forEach(msg => {
                const isOut = msg.senderId === currentUser.id;
                const div = document.createElement('div');
                div.className = `message ${isOut ? 'out' : 'in'}`;
                div.innerHTML = `
                    ${msg.text}
                    <small>
                        ${new Date(msg.timestamp).toLocaleTimeString()}
                        ${isOut ? getStatusIcons(msg.status) : ''}
                    </small>
                `;
                messagesContainer.appendChild(div);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getStatusIcons(status) {
            if (status === 'sent') return ' ‚úì';
            if (status === 'delivered') return ' ‚úì‚úì';
            if (status === 'read') return ' ‚úì‚úì‚úì';
            return '';
        }

        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUser || !currentContact) return;

            const newMsg = {
                id: 'msg_' + Date.now() + Math.random(),
                senderId: currentUser.id,
                receiverId: currentContact.id,
                text: text,
                status: 'sent',
                timestamp: new Date().toISOString()
            };
            const messages = getMessages();
            messages.push(newMsg);
            saveMessages(messages);
            renderMessages();
            messageInput.value = '';

            // –≠–º—É–ª—è—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –ø—Ä–æ—á—Ç–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ç–∞–π–º–µ—Ä—ã (–µ—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ–Ω–ª–∞–π–Ω)
            setTimeout(() => {
                const msg = messages.find(m => m.id === newMsg.id);
                if (msg && msg.status === 'sent') {
                    msg.status = 'delivered';
                    saveMessages(messages);
                    renderMessages();
                }
            }, 2000);
            setTimeout(() => {
                const msg = messages.find(m => m.id === newMsg.id);
                if (msg && msg.status === 'delivered') {
                    msg.status = 'read';
                    saveMessages(messages);
                    renderMessages();
                }
            }, 4000);
        }

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        window.addEventListener('storage', (e) => {
            if (e.key === STORAGE_KEYS.messages) {
                if (currentContact && chatScreen.classList.contains('active')) {
                    renderMessages();
                }
            }
            if (e.key === STORAGE_KEYS.users) {
                if (currentContact) {
                    updateContactStatus(currentContact);
                }
                if (contactsScreen.classList.contains('active')) {
                    renderContactsScreen();
                }
            }
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ (–±—É–¥–µ—Ç –Ω–∏–∂–µ)
            if (e.key === 'call_incoming') {
                // –î–∞–Ω–Ω—ã–µ –æ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª—é—á
                const callData = JSON.parse(e.newValue);
                if (callData && callData.calleeId === currentUser?.id) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ
                    incomingCallerName.textContent = callData.callerName;
                    incomingCallDiv.classList.add('active');
                    callState.isIncoming = true;
                    callState.withUserId = callData.callerId;
                }
            }
            if (e.key === 'call_answer') {
                const answer = JSON.parse(e.newValue);
                if (answer.callerId === currentUser?.id && callScreen.classList.contains('active')) {
                    callStatus.textContent = '–†–∞–∑–≥–æ–≤–æ—Ä';
                }
            }
            if (e.key === 'call_end') {
                const end = JSON.parse(e.newValue);
                if (end.targetId === currentUser?.id) {
                    callScreen.classList.remove('active');
                    incomingCallDiv.classList.remove('active');
                    showToast('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω');
                }
            }
        });

        // ======================== –ó–≤–æ–Ω–∫–∏ (—ç–º—É–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ localStorage) ========================
        callButton.addEventListener('click', initiateCall);

        function initiateCall() {
            if (!currentContact) return;
            callState.active = true;
            callState.withUserId = currentContact.id;
            callState.isIncoming = false;
            callScreen.classList.add('active');
            callStatus.textContent = '–ó–≤–æ–Ω–∏–º...';
            callAvatar.textContent = currentContact.name[0] || 'üë§';

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ localStorage
            const callData = {
                callerId: currentUser.id,
                callerName: currentUser.name,
                calleeId: currentContact.id,
                timestamp: Date.now()
            };
            localStorage.setItem('call_incoming', JSON.stringify(callData));
            // –ß–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è —ç–º—É–ª–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç (–¥–ª—è –¥–µ–º–æ)
            setTimeout(() => {
                if (callState.active && callState.withUserId === currentContact.id) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∑–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω
                    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –∑–≤–æ–Ω–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è
                    callStatus.textContent = '–†–∞–∑–≥–æ–≤–æ—Ä';
                }
            }, 3000);
        }

        acceptCallBtn.addEventListener('click', () => {
            incomingCallDiv.classList.remove('active');
            callScreen.classList.add('active');
            callStatus.textContent = '–†–∞–∑–≥–æ–≤–æ—Ä';
            callState.active = true;
            callState.isIncoming = false;
            callAvatar.textContent = currentContact?.name[0] || 'üë§';

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∑–≤–æ–Ω—è—â–µ–º—É
            const answerData = {
                callerId: callState.withUserId,
                calleeId: currentUser.id,
                accepted: true
            };
            localStorage.setItem('call_answer', JSON.stringify(answerData));
        });

        declineCallBtn.addEventListener('click', () => {
            incomingCallDiv.classList.remove('active');
            callState.active = false;
            showToast('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω');
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –∑–≤–æ–Ω—è—â–µ–≥–æ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏
            const declineData = {
                callerId: callState.withUserId,
                calleeId: currentUser.id,
                declined: true
            };
            localStorage.setItem('call_decline', JSON.stringify(declineData));
        });

        endCallBtn.addEventListener('click', endCall);
        function endCall() {
            callScreen.classList.remove('active');
            incomingCallDiv.classList.remove('active');
            if (callState.withUserId) {
                const endData = { targetId: callState.withUserId };
                localStorage.setItem('call_end', JSON.stringify(endData));
            }
            callState.active = false;
            showToast('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω');
        }

        muteMicrophoneBtn.addEventListener('click', () => {
            callState.isMuted = !callState.isMuted;
            muteMicrophoneBtn.style.opacity = callState.isMuted ? 0.5 : 1;
            muteMicrophoneBtn.textContent = callState.isMuted ? 'üîá' : 'üé§';
        });

        // ======================== –ù–∞–≤–∏–≥–∞—Ü–∏—è ========================
        backToContacts.addEventListener('click', () => {
            switchScreen('contacts');
            renderContactsScreen();
        });

        logoutBtn.addEventListener('click', () => {
            if (currentUser) {
                setUserOnline(currentUser.id, false);
                localStorage.removeItem(STORAGE_KEYS.currentUser);
                currentUser = null;
                switchScreen('register');
                showToast('–í—ã –≤—ã—à–ª–∏');
            }
        });

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ —á–∞—Ç–µ
        setInterval(() => {
            if (currentContact) {
                const users = getUsers();
                const updated = users.find(u => u.id === currentContact.id);
                if (updated) {
                    currentContact.isOnline = updated.isOnline;
                    currentContact.lastSeen = updated.lastSeen;
                    chatContactStatus.textContent = updated.isOnline ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ';
                }
            }
        }, 2000);

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        setInterval(() => {
            if (currentContact && chatScreen.classList.contains('active')) {
                renderMessages();
            }
        }, 1000);

        // –°—Ç–∞—Ä—Ç
        loadCurrentUser();
    })();
</script>
</body>
</html>
