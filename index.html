<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Yourblocks ‚Äî –ù–∞–¥—ë–∂–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* –í—Å–µ –∏—Å—Ö–æ–¥–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            overflow: hidden;
            background: #141414;
            touch-action: none;
        }
        #login-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }
        .login-container {
            background: rgba(30, 30, 40, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 30px;
            width: 90%;
            max-width: 400px;
            border: 2px solid #4CAF50;
            box-shadow: 0 0 50px rgba(76, 175, 80, 0.3);
            animation: slideUp 0.5s;
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .login-logo {
            text-align: center;
            font-size: 48px;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        .login-title {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            color: white;
        }
        .login-subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 50px;
        }
        .login-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.3s;
            color: #888;
            font-weight: bold;
        }
        .login-tab.active {
            background: #4CAF50;
            color: white;
        }
        .login-form {
            display: none;
        }
        .login-form.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            color: #888;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #333;
            border-radius: 15px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .login-btn {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        .login-btn:hover {
            transform: scale(1.02);
            background: #45a049;
        }
        .guest-btn {
            width: 100%;
            padding: 15px;
            background: transparent;
            color: #888;
            border: 2px solid #333;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .guest-btn:hover {
            border-color: #4CAF50;
            color: white;
        }
        .error-message {
            color: #ff5555;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π */
        .suggested-names {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .suggested-name {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
        }
        .suggested-name:hover {
            background: #4CAF50;
            color: white;
            transform: scale(1.05);
        }
        .suggested-name:active {
            transform: scale(0.95);
        }
        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        #menu-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #141414;
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            color: white;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100%;
            background: #1e1e1e;
            padding: 20px 0;
            border-right: 1px solid #333;
            z-index: 100;
        }
        .sidebar-header {
            padding: 0 20px 20px 20px;
            border-bottom: 1px solid #333;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 20px;
        }
        .logo span {
            color: #4CAF50;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            background: #2a2a2a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid #4CAF50;
        }
        .user-info-side {
            flex: 1;
        }
        .user-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
            color: #fff;
        }
        .user-status {
            font-size: 12px;
            color: #4CAF50;
        }
        .user-status span {
            color: #888;
            margin-left: 5px;
        }
        .nav-menu {
            padding: 20px 0;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-item:hover {
            background: #2a2a2a;
            color: #fff;
        }
        .nav-item.active {
            background: #4CAF50;
            color: white;
        }
        .nav-item i {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px 30px;
            min-height: 100vh;
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .content-header h1 {
            font-size: 28px;
            color: #fff;
        }
        .header-stats {
            display: flex;
            gap: 20px;
            color: #888;
        }
        .header-stats span {
            color: #4CAF50;
            font-weight: bold;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        .game-card-large {
            background: #1e1e1e;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            max-width: 600px;
            margin: 0 auto;
        }
        .game-card-large:hover {
            transform: translateY(-5px);
            border-color: #4CAF50;
        }
        .game-card-large.selected {
            border-color: #4CAF50;
            box-shadow: 0 0 40px rgba(76, 175, 80, 0.4);
        }
        .game-image-large {
            height: 200px;
            background: linear-gradient(135deg, #2a5a2a, #1a3a1a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            position: relative;
        }
        .game-image-large::after {
            content: '‚ñ∂';
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .game-card-large:hover .game-image-large::after {
            opacity: 1;
        }
        .game-info-large {
            padding: 25px;
            text-align: center;
        }
        .game-title-large {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        .game-description-large {
            font-size: 16px;
            color: #888;
            margin-bottom: 20px;
        }
        .game-features {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .feature {
            text-align: center;
        }
        .feature-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .feature-text {
            font-size: 14px;
            color: #888;
        }
        .feature-text span {
            color: #4CAF50;
            font-weight: bold;
        }
        .profile-header {
            background: #1e1e1e;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }
        .profile-avatar-large {
            width: 120px;
            height: 120px;
            background: #2a2a2a;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            border: 4px solid #4CAF50;
        }
        .profile-info h2 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #fff;
        }
        .profile-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            color: #888;
            font-size: 13px;
        }
        .customization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .color-section {
            background: #1e1e1e;
            border-radius: 16px;
            padding: 20px;
        }
        .color-section h3 {
            margin-bottom: 15px;
            color: #fff;
            font-size: 16px;
        }
        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .color-option {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 15px currentColor;
        }
        .play-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.5);
            z-index: 1001;
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .play-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(76, 175, 80, 0.7);
        }
        .play-button:active {
            transform: scale(0.95);
        }
        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: none;
        }
        #game-container.active {
            display: block;
        }
        .game-exit-button {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 200;
            background: rgba(255, 80, 80, 0.9);
            color: white;
            border: 2px solid white;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            font-size: 24px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
            transition: all 0.3s;
        }
        .game-exit-button:hover {
            transform: scale(1.1);
            background: rgba(255, 40, 40, 1);
        }
        .game-exit-button:active {
            transform: scale(0.95);
        }
        .exit-hint {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 200;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 12px;
            border: 1px solid #ff5555;
            backdrop-filter: blur(5px);
        }
        .ground-indicator {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 14px;
            border: 2px solid #4CAF50;
            z-index: 200;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }
        .ground-indicator.onground {
            border-color: #4CAF50;
            color: #4CAF50;
        }
        .ground-indicator.air {
            border-color: #ff5555;
            color: #ff5555;
        }
        .players-count {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 200;
            background: rgba(0,0,0,0.7);
            color: #4CAF50;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 14px;
            border: 2px solid #4CAF50;
            backdrop-filter: blur(5px);
        }
        .server-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            background: rgba(0,0,0,0.7);
            color: #4CAF50;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 14px;
            border: 2px solid #4CAF50;
            backdrop-filter: blur(5px);
            white-space: nowrap;
        }
        .jump-hint {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            z-index: 200;
        }
        #mobile-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 150;
            pointer-events: none;
            display: none;
        }
        #mobile-controls.active {
            display: block;
        }
        #left-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            z-index: 151;
            pointer-events: auto;
            background: transparent;
            touch-action: none;
        }
        #right-area {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            z-index: 151;
            pointer-events: auto;
            background: transparent;
            touch-action: none;
        }
        #joystick-left {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            background: rgba(30, 30, 40, 0.7);
            border-radius: 60px;
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            z-index: 152;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #joystick-handle {
            width: 50px;
            height: 50px;
            background: rgba(76, 175, 80, 0.9);
            border-radius: 25px;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            transition: transform 0.01s;
            border: 2px solid white;
        }
        #jump-button {
            position: absolute;
            bottom: 40px;
            right: 40px;
            width: 100px;
            height: 100px;
            background: rgba(255, 80, 80, 0.9);
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 3px solid white;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            z-index: 152;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.1s;
        }
        #jump-button.active {
            transform: scale(0.9);
            background: rgba(255, 40, 40, 1);
        }
        .logout-btn {
            position: fixed;
            top: 20px;
            left: 270px;
            background: rgba(255, 80, 80, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1002;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid white;
            transition: all 0.3s;
        }
        .logout-btn:hover {
            background: rgba(255, 40, 40, 1);
            transform: scale(1.05);
        }
        .logout-btn:active {
            transform: scale(0.95);
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            .sidebar .logo,
            .user-profile,
            .nav-item span {
                display: none;
            }
            .main-content {
                margin-left: 70px;
                padding: 15px;
            }
            .nav-item {
                justify-content: center;
                padding: 15px;
            }
            .nav-item i {
                margin: 0;
                font-size: 24px;
            }
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            .game-features {
                flex-direction: column;
                gap: 15px;
            }
            .play-button {
                bottom: 20px;
                right: 20px;
                padding: 12px 25px;
                font-size: 16px;
            }
            .logout-btn {
                left: 90px;
                padding: 8px 15px;
                font-size: 12px;
            }
            .game-exit-button {
                width: 60px;
                height: 60px;
                font-size: 30px;
            }
            .server-status {
                font-size: 12px;
                padding: 5px 10px;
                top: 10px;
            }
            .players-count {
                font-size: 12px;
                padding: 5px 10px;
                top: 10px;
                left: 10px;
            }
            #joystick-left {
                width: 100px;
                height: 100px;
                bottom: 30px;
                left: 30px;
            }
            #joystick-handle {
                width: 40px;
                height: 40px;
            }
            #jump-button {
                width: 80px;
                height: 80px;
                bottom: 30px;
                right: 30px;
                font-size: 16px;
            }
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Ñ–æ—Ç–æ */
        #manual-connect, .jump-hint, #ground-indicator {
            display: none !important;
        }

        /* –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å */
        #debug-panel {
            position: absolute;
            bottom: 250px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #0ff;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 12px;
            z-index: 300;
            border: 2px solid #0ff;
            display: none;
            max-width: 80%;
            word-break: break-word;
            text-align: center;
            pointer-events: none;
        }
    </style>
    <!-- Firebase SDK —Å Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">üß±</div>
            <div class="login-title">YOURBLOCKS</div>
            <div class="login-subtitle">–í–æ–π–¥–∏, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>
            <div class="login-tabs">
                <div class="login-tab active" onclick="switchLoginTab('login')">–í—Ö–æ–¥</div>
                <div class="login-tab" onclick="switchLoginTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>
            <div id="login-form" class="login-form active">
                <div class="input-group">
                    <label>üë§ –õ–æ–≥–∏–Ω</label>
                    <input type="text" id="login-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="input-group">
                    <label>üîí –ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="login-btn" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
                <button class="guest-btn" onclick="handleGuest()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ –≥–æ—Å—Ç—å</button>
                <div id="login-error" class="error-message"></div>
            </div>
            <div id="register-form" class="login-form">
                <div class="input-group">
                    <label>üë§ –õ–æ–≥–∏–Ω</label>
                    <input type="text" id="register-username" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="input-group">
                    <label>üîí –ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="register-password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="input-group">
                    <label>üîí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</label>
                    <input type="password" id="register-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="login-btn" onclick="handleRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button class="guest-btn" onclick="handleGuest()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ –≥–æ—Å—Ç—å</button>
                <div id="register-error" class="error-message"></div>
                <!-- –ë–ª–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π -->
                <div id="suggested-usernames" class="suggested-names"></div>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
    <div id="menu-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">YOUR<span>BLOCKS</span></div>
                <div class="user-profile">
                    <div class="user-avatar" id="sidebar-avatar">üß±</div>
                    <div class="user-info-side">
                        <div class="user-name" id="sidebar-username">–ì–æ—Å—Ç—å</div>
                        <div class="user-status" id="sidebar-status">50 <span>–ë–ª–∏–∑–∫–∏–π</span></div>
                    </div>
                </div>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="switchPage('home')">
                    <i>üè†</i>
                    <span>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</span>
                </div>
                <div class="nav-item" onclick="switchPage('profile')">
                    <i>üë§</i>
                    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                </div>
                <div class="nav-item" onclick="switchPage('avatar')">
                    <i>üé®</i>
                    <span>–ê–≤–∞—Ç–∞—Ä</span>
                </div>
                <div class="nav-item" onclick="switchPage('settings')">
                    <i>‚öôÔ∏è</i>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
                <div class="nav-item" onclick="switchPage('friends')">
                    <i>üë•</i>
                    <span>–î—Ä—É–∑—å—è</span>
                </div>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">
            <span>üö™</span> –í—ã–π—Ç–∏
        </button>
        <div class="main-content">
            <div class="content-header">
                <h1 id="page-title">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h1>
                <div class="header-stats">
                    <div>üë• <span id="global-online">1</span> –æ–Ω–ª–∞–π–Ω</div>
                    <div>üéÆ <span>1</span> –∏–≥—Ä–∞</div>
                </div>
            </div>
            <div id="home-section" class="content-section active">
                <h2 style="color: #fff; margin-bottom: 30px; text-align: center;">üî• –ò–≥—Ä–∞ –¥–Ω—è</h2>
                <div class="game-card-large" onclick="selectGame()">
                    <div class="game-image-large">üèÉ‚Äç‚ôÇÔ∏è</div>
                    <div class="game-info-large">
                        <div class="game-title-large">PARKOUR MAZE</div>
                        <div class="game-description-large">–ü–∞—Ä–∫—É—Ä + –õ–∞–±–∏—Ä–∏–Ω—Ç ‚Äî –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä!</div>
                        <div class="game-features">
                            <div class="feature">
                                <div class="feature-icon">üèÉ</div>
                                <div class="feature-text"><span>20</span> –ø–ª–∞—Ç—Ñ–æ—Ä–º</div>
                            </div>
                            <div class="feature">
                                <div class="feature-icon">üß±</div>
                                <div class="feature-text"><span>–ª–∞–±–∏—Ä–∏–Ω—Ç</span> —Å–ø—Ä–∞–≤–∞</div>
                            </div>
                            <div class="feature">
                                <div class="feature-icon">üåê</div>
                                <div class="feature-text"><span>–æ–±—â–∏–π</span> —Å–µ—Ä–≤–µ—Ä</div>
                            </div>
                            <div class="feature">
                                <div class="feature-icon">üë•</div>
                                <div class="feature-text"><span id="game-players">1</span> —Å–µ–π—á–∞—Å</div>
                            </div>
                        </div>
                        <div style="margin-top: 25px; color: #4CAF50; font-size: 18px;">
                            ‚≠ê 4.9 (2.5K –æ—Ç–∑—ã–≤–æ–≤)
                        </div>
                    </div>
                </div>
                <div id="selected-game-info" style="margin-top: 30px; padding: 20px; background: #1e1e1e; border-radius: 16px;">
                    <div style="display: flex; justify-content: center;">
                        <button class="play-button" style="position: static;" onclick="startGame()">‚ñ∂ –í–û–ô–¢–ò –í –ò–ì–†–£</button>
                    </div>
                </div>
            </div>
            <div id="profile-section" class="content-section">
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profile-avatar">üß±</div>
                    <div class="profile-info">
                        <h2 id="profile-username">–ì–æ—Å—Ç—å</h2>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value">50</div>
                                <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="profile-friends-count">0</div>
                                <div class="stat-label">–î—Ä—É–∑—å—è</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">567</div>
                                <div class="stat-label">–ò–≥—Ä—ã</div>
                            </div>
                        </div>
                    </div>
                </div>
                <h3 style="color: #fff; margin: 20px 0;">–ù–µ–¥–∞–≤–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                <div style="background: #1e1e1e; border-radius: 16px; padding: 20px;">
                    <p style="color: #888;">üèÜ –ü—Ä–æ–π–¥–µ–Ω –ª–∞–±–∏—Ä–∏–Ω—Ç –∑–∞ 2 –º–∏–Ω—É—Ç—ã</p>
                    <p style="color: #888;">‚≠ê –°–æ–±—Ä–∞–Ω–æ 50 –º–æ–Ω–µ—Ç –≤ –ø–∞—Ä–∫—É—Ä–µ</p>
                    <p style="color: #888;">üöÄ 100 –ø—Ä—ã–∂–∫–æ–≤ –±–µ–∑ –ø–∞–¥–µ–Ω–∏—è</p>
                </div>
            </div>
            <div id="avatar-section" class="content-section">
                <h2 style="color: #fff; margin-bottom: 20px;">–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –∞–≤–∞—Ç–∞—Ä–∞</h2>
                <div style="display: flex; gap: 30px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div class="profile-avatar-large" id="customize-avatar">üß±</div>
                    <div style="flex: 1; min-width: 200px;">
                        <p style="color: #888;">–ù–∞—Å—Ç—Ä–æ–π –≤–Ω–µ—à–Ω–æ—Å—Ç—å —Å–≤–æ–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</p>
                    </div>
                </div>
                <div class="customization-grid">
                    <div class="color-section">
                        <h3>üë§ –ì–æ–ª–æ–≤–∞</h3>
                        <div class="color-picker">
                            <div class="color-option" style="background: #ffccaa;" onclick="setPartColor('head', '#ffccaa', this)"></div>
                            <div class="color-option" style="background: #8b5a2b;" onclick="setPartColor('head', '#8b5a2b', this)"></div>
                            <div class="color-option" style="background: #f5deb3;" onclick="setPartColor('head', '#f5deb3', this)"></div>
                            <div class="color-option" style="background: #d2b48c;" onclick="setPartColor('head', '#d2b48c', this)"></div>
                            <div class="color-option" style="background: #cd853f;" onclick="setPartColor('head', '#cd853f', this)"></div>
                        </div>
                    </div>
                    <div class="color-section">
                        <h3>üëï –¢–µ–ª–æ</h3>
                        <div class="color-picker">
                            <div class="color-option" style="background: #3366ff;" onclick="setPartColor('body', '#3366ff', this)"></div>
                            <div class="color-option" style="background: #ff4444;" onclick="setPartColor('body', '#ff4444', this)"></div>
                            <div class="color-option" style="background: #44ff44;" onclick="setPartColor('body', '#44ff44', this)"></div>
                            <div class="color-option" style="background: #ffff44;" onclick="setPartColor('body', '#ffff44', this)"></div>
                            <div class="color-option" style="background: #ff44ff;" onclick="setPartColor('body', '#ff44ff', this)"></div>
                        </div>
                    </div>
                    <div class="color-section">
                        <h3>ü¶µ –ù–æ–≥–∏</h3>
                        <div class="color-picker">
                            <div class="color-option" style="background: #2244aa;" onclick="setPartColor('legs', '#2244aa', this)"></div>
                            <div class="color-option" style="background: #aa2222;" onclick="setPartColor('legs', '#aa2222', this)"></div>
                            <div class="color-option" style="background: #22aa22;" onclick="setPartColor('legs', '#22aa22', this)"></div>
                            <div class="color-option" style="background: #aaaa22;" onclick="setPartColor('legs', '#aaaa22', this)"></div>
                            <div class="color-option" style="background: #aa22aa;" onclick="setPartColor('legs', '#aa22aa', this)"></div>
                        </div>
                    </div>
                    <div class="color-section">
                        <h3>ü´± –†—É–∫–∏</h3>
                        <div class="color-picker">
                            <div class="color-option" style="background: #2244aa;" onclick="setPartColor('arms', '#2244aa', this)"></div>
                            <div class="color-option" style="background: #aa2222;" onclick="setPartColor('arms', '#aa2222', this)"></div>
                            <div class="color-option" style="background: #22aa22;" onclick="setPartColor('arms', '#22aa22', this)"></div>
                            <div class="color-option" style="background: #aaaa22;" onclick="setPartColor('arms', '#aaaa22', this)"></div>
                            <div class="color-option" style="background: #aa22aa;" onclick="setPartColor('arms', '#aa22aa', this)"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- –ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" -->
            <div id="settings-section" class="content-section">
                <h2 style="color: #fff; margin-bottom: 20px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
                <div style="background: #1e1e1e; border-radius: 16px; padding: 30px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3 style="color: #fff; margin-bottom: 10px;">–£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
                    <p style="color: #888; margin-bottom: 30px;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞.</p>
                    <button class="login-btn" style="background: #ff5555; width: auto; display: inline-block; padding: 15px 40px;" onclick="deleteAccount()">–£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
                </div>
            </div>
            <div id="friends-section" class="content-section">
                <div style="text-align: center; padding: 50px; color: #888;">
                    <div style="font-size: 64px;">üë•</div>
                    <h3>–î—Ä—É–∑—å—è</h3>
                    <p>–í –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–µ –≤—ã –º–æ–∂–µ—Ç–µ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å –¥—Ä—É–∑–µ–π!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div id="game-container">
        <button class="game-exit-button" onclick="exitGame()">‚úï</button>
        <div class="exit-hint">–ù–∞–∂–º–∏ ESC –∏–ª–∏ ‚úï —á—Ç–æ–±—ã –≤—ã–π—Ç–∏</div>
        <div class="server-status" id="server-status">üîµ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...</div>
        <div class="players-count" id="players-count">üë• 1 –≤ –∫–æ–º–Ω–∞—Ç–µ</div>

        <!-- –°–∫—Ä—ã—Ç—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (—É–¥–∞–ª–µ–Ω—ã —Å —Ñ–æ—Ç–æ) -->
        <div class="ground-indicator onground" id="ground-indicator">üü¢ –ù–ê –ó–ï–ú–õ–ï</div>
        <div class="jump-hint">üëÜ –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –¥–≤–∏–∂–µ–Ω–∏–µ, –ø—Ä–∞–≤–∞—è - –∫–∞–º–µ—Ä–∞ + –ø—Ä—ã–∂–æ–∫</div>
        <div id="manual-connect">
            <input type="text" id="peer-id-input" placeholder="ID –¥—Ä—É–≥–∞">
            <button onclick="manualConnect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>

        <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div id="debug-panel"></div>

        <div id="mobile-controls">
            <div id="left-area"></div>
            <div id="right-area"></div>
            <div id="joystick-left">
                <div id="joystick-handle"></div>
            </div>
            <div id="jump-button">
                –ü–†–´–ñ–û–ö
            </div>
        </div>

        <div id="game-canvas"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>

    <script>
        // ==================== FIREBASE –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCMgDxuPbye5rpZcS7JAHD_6PEDbAc3ZdU",
            authDomain: "yourblocks-ccdb7.firebaseapp.com",
            projectId: "yourblocks-ccdb7",
            storageBucket: "yourblocks-ccdb7.firebasestorage.app",
            messagingSenderId: "531017606276",
            appId: "1:531017606276:web:5eab2f87a2f9f5c885ced1",
            measurementId: "G-JSWF0QVSJ9"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentUser = null;
        let playerColors = {
            head: '#ffccaa',
            body: '#3366ff',
            legs: '#2244aa',
            arms: '#2244aa'
        };
        let sessionListener = null;

        // –°–ø–∏—Å–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∏–∫–æ–≤ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å)
        const namePrefixes = [
            'Cool', 'Fast', 'Shadow', 'Crazy', 'Neon', 'Space', 'Dark', 'Fire', 'Ice', 'Star',
            'Wolf', 'Dragon', 'Phoenix', 'Thunder', 'Storm', 'Blaze', 'Ghost', 'Hunter', 'Knight', 'Ninja',
            'Panda', 'Tiger', 'Eagle', 'Falcon', 'Raven', 'Owl', 'Lion', 'Bear', 'Shark', 'Whale',
            '–ë—ã—Å—Ç—Ä—ã–π', '–°–º–µ–ª—ã–π', '–¢—ë–º–Ω—ã–π', '–Ø—Ä–∫–∏–π', '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π', '–û–≥–Ω–µ–Ω–Ω—ã–π', '–õ–µ–¥—è–Ω–æ–π', '–ó–≤—ë–∑–¥–Ω—ã–π',
            '–í–æ–ª–∫', '–î—Ä–∞–∫–æ–Ω', '–§–µ–Ω–∏–∫—Å', '–ì—Ä–æ–º', '–ë—É—Ä—è', '–ü–ª–∞–º—è', '–ü—Ä–∏–∑—Ä–∞–∫', '–û—Ö–æ—Ç–Ω–∏–∫', '–†—ã—Ü–∞—Ä—å', '–ù–∏–Ω–¥–∑—è',
            '–ü–∞–Ω–¥–∞', '–¢–∏–≥—Ä', '–û—Ä—ë–ª', '–°–æ–∫–æ–ª', '–í–æ—Ä–æ–Ω', '–°–æ–≤–∞', '–õ–µ–≤', '–ú–µ–¥–≤–µ–¥—å', '–ê–∫—É–ª–∞', '–ö–∏—Ç'
        ];
        const nameSuffixes = [
            'Player', 'Gamer', 'Master', 'Pro', 'King', 'Queen', 'Lord', 'Warrior', 'Killer', 'Hero',
            '–ò–≥—Ä–æ–∫', '–ú–∞—Å—Ç–µ—Ä', '–ö–æ—Ä–æ–ª—å', '–ö–æ—Ä–æ–ª–µ–≤–∞', '–í–ª–∞—Å—Ç–µ–ª–∏–Ω', '–í–æ–∏–Ω', '–£–±–∏–π—Ü–∞', '–ì–µ—Ä–æ–π'
        ];

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –Ω–∏–∫–∞ –≤ email
        function nickToEmail(nick) {
            return nick.trim().toLowerCase().replace(/\s+/g, '') + '@yourblocks-ccdb7.firebaseapp.com';
        }

        // ==================== –ü–†–û–í–ï–†–ö–ê –°–í–û–ë–û–î–ï–ù –õ–ò –ù–ò–ö ====================
        async function isUsernameFree(username) {
            if (!username) return false;
            const snapshot = await db.collection('users').where('username', '==', username).get();
            return snapshot.empty;
        }

        // ==================== –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–õ–£–ß–ê–ô–ù–û–ì–û –ù–ò–ö–ê ====================
        function generateRandomUsername() {
            const usePrefixFirst = Math.random() > 0.5;
            let name = '';
            if (usePrefixFirst) {
                name = namePrefixes[Math.floor(Math.random() * namePrefixes.length)];
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –∏–ª–∏ —Å—É—Ñ—Ñ–∏–∫—Å
                if (Math.random() > 0.6) {
                    name += Math.floor(Math.random() * 1000);
                } else {
                    name += nameSuffixes[Math.floor(Math.random() * nameSuffixes.length)];
                }
            } else {
                name = nameSuffixes[Math.floor(Math.random() * nameSuffixes.length)];
                name += namePrefixes[Math.floor(Math.random() * namePrefixes.length)];
            }
            // –ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏–º–≤–æ–ª—ã
            if (Math.random() > 0.7) {
                const symbols = ['_', '.', '-', ''];
                name += symbols[Math.floor(Math.random() * symbols.length)] + Math.floor(Math.random() * 100);
            }
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∏–∫ –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
            if (name.length > 20) name = name.substring(0, 20);
            return name;
        }

        // ==================== –ü–û–õ–£–ß–ò–¢–¨ –ù–ï–°–ö–û–õ–¨–ö–û –°–í–û–ë–û–î–ù–´–• –ù–ò–ö–û–í ====================
        async function getFreeUsernames(count = 3) {
            const freeNames = [];
            const attempts = new Set();
            // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
            for (let i = 0; i < 30 && freeNames.length < count; i++) {
                const candidate = generateRandomUsername();
                if (attempts.has(candidate)) continue;
                attempts.add(candidate);
                if (await isUsernameFree(candidate)) {
                    freeNames.push(candidate);
                }
            }
            return freeNames;
        }

        // ==================== –û–ë–ù–û–í–ò–¢–¨ –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø ====================
        async function refreshSuggestions() {
            const container = document.getElementById('suggested-usernames');
            if (!container) return;
            container.innerHTML = ''; // –æ—á–∏—â–∞–µ–º
            const freeNames = await getFreeUsernames(3);
            freeNames.forEach(name => {
                const span = document.createElement('span');
                span.className = 'suggested-name';
                span.textContent = name;
                span.onclick = () => {
                    document.getElementById('register-username').value = name;
                };
                container.appendChild(span);
            });
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –í–•–û–î–ê / –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ====================
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            document.getElementById(tab + '-form').classList.add('active');
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
            if (tab === 'register') {
                refreshSuggestions();
            }
        }

        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorDiv = document.getElementById('login-error');
            if (!username || !password) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorDiv.style.display = 'block';
                return;
            }
            const email = nickToEmail(username);
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    currentUser = { uid: user.uid, username: username, ...doc.data() };
                } else {
                    currentUser = {
                        uid: user.uid,
                        username: username,
                        level: 1,
                        games: 0,
                        colors: { head: '#ffccaa', body: '#3366ff', legs: '#2244aa', arms: '#2244aa' },
                        friends: {},
                        friendRequests: {}
                    };
                    await db.collection('users').doc(user.uid).set(currentUser);
                }
                
                const sessionId = Math.random().toString(36).substring(2) + Date.now();
                await db.collection('users').doc(user.uid).update({ sessionId });
                currentUser.sessionId = sessionId;

                if (sessionListener) sessionListener();
                sessionListener = db.collection('users').doc(user.uid).onSnapshot((docSnapshot) => {
                    if (docSnapshot.exists) {
                        const data = docSnapshot.data();
                        if (data.sessionId && data.sessionId !== currentUser.sessionId) {
                            // –ó–ê–ú–ï–ù–ê –¢–ï–ö–°–¢–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
                            alert('–í —ç—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç –≤–æ—à–ª–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—ã, —Å—Ä–æ—á–Ω–æ –ø–æ–º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–æ–ª—å.');
                            logout();
                        }
                    } else {
                        alert('–ê–∫–∫–∞—É–Ω—Ç –±—ã–ª —É–¥–∞–ª—ë–Ω.');
                        logout();
                    }
                });

                if (currentUser.colors) playerColors = currentUser.colors;
                updateAllAvatars();
                loginSuccess();
            } catch (error) {
                console.error(error);
                let message = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ';
                if (error.code === 'auth/user-not-found') {
                    message = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–∏–∫–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω';
                } else if (error.code === 'auth/wrong-password') {
                    message = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                } else if (error.code === 'auth/invalid-email') {
                    message = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∏–∫';
                } else {
                    message = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                }
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        async function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const confirm = document.getElementById('register-confirm').value.trim();
            const errorDiv = document.getElementById('register-error');
            if (!username || !password || !confirm) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorDiv.style.display = 'block';
                return;
            }
            if (password !== confirm) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                errorDiv.style.display = 'block';
                return;
            }
            if (password.length < 6) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                errorDiv.style.display = 'block';
                return;
            }
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                errorDiv.textContent = '–õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ';
                errorDiv.style.display = 'block';
                return;
            }
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ –Ω–∏–∫ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)
            const free = await isUsernameFree(username);
            if (!free) {
                errorDiv.textContent = '–ê–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º –Ω–∏–∫–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                errorDiv.style.display = 'block';
                refreshSuggestions(); // –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                return;
            }
            const email = nickToEmail(username);
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const newUser = {
                    username: username,
                    level: 1,
                    games: 0,
                    colors: { head: '#ffccaa', body: '#3366ff', legs: '#2244aa', arms: '#2244aa' },
                    friends: {},
                    friendRequests: {},
                    created: Date.now()
                };
                await db.collection('users').doc(user.uid).set(newUser);
                
                const sessionId = Math.random().toString(36).substring(2) + Date.now();
                await db.collection('users').doc(user.uid).update({ sessionId });
                newUser.sessionId = sessionId;
                currentUser = { uid: user.uid, ...newUser };
                playerColors = newUser.colors;

                if (sessionListener) sessionListener();
                sessionListener = db.collection('users').doc(user.uid).onSnapshot((docSnapshot) => {
                    if (docSnapshot.exists) {
                        const data = docSnapshot.data();
                        if (data.sessionId && data.sessionId !== currentUser.sessionId) {
                            alert('–í —ç—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç –≤–æ—à–ª–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—ã, —Å—Ä–æ—á–Ω–æ –ø–æ–º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–æ–ª—å.');
                            logout();
                        }
                    } else {
                        alert('–ê–∫–∫–∞—É–Ω—Ç –±—ã–ª —É–¥–∞–ª—ë–Ω.');
                        logout();
                    }
                });

                updateAllAvatars();
                loginSuccess();
            } catch (error) {
                console.error(error);
                if (error.code === 'auth/email-already-exists') {
                    errorDiv.textContent = '–ê–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º –Ω–∏–∫–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                } else {
                    errorDiv.textContent = '–û—à–∏–±–∫–∞: ' + (error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è');
                }
                errorDiv.style.display = 'block';
                refreshSuggestions(); // –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
            }
        }

        function handleGuest() {
            currentUser = {
                username: '–ì–æ—Å—Ç—å_' + Math.floor(Math.random() * 10000),
                level: 1,
                games: 0,
                isGuest: true,
                colors: playerColors
            };
            loginSuccess();
        }

        function loginSuccess() {
            document.getElementById('sidebar-username').textContent = currentUser.username;
            document.getElementById('profile-username').textContent = currentUser.username;
            if (currentUser.isGuest) {
                document.getElementById('sidebar-status').innerHTML = 'üë§ <span>–ì–æ—Å—Ç—å</span>';
            } else {
                document.getElementById('sidebar-status').innerHTML = (currentUser.level || 1) + ' <span>–ë–ª–∏–∑–∫–∏–π</span>';
                document.getElementById('profile-friends-count').textContent = currentUser.friends ? Object.keys(currentUser.friends).length : 0;
            }
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('menu-container').style.display = 'flex';
            }, 500);
        }

        async function logout() {
            if (sessionListener) {
                sessionListener();
                sessionListener = null;
            }
            if (!currentUser?.isGuest && currentUser?.uid) {
                if (currentUser.colors) currentUser.colors = playerColors;
                try {
                    await db.collection('users').doc(currentUser.uid).update({ colors: playerColors });
                } catch (e) { console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', e); }
            }
            await auth.signOut();
            currentUser = null;
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-screen').style.opacity = '1';
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('register-username').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-confirm').value = '';
        }

        async function deleteAccount() {
            if (!currentUser) return;
            if (currentUser.isGuest) {
                alert('–ì–æ—Å—Ç–∏ –Ω–µ –º–æ–≥—É—Ç —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç. –ü—Ä–æ—Å—Ç–æ –≤—ã–π–¥–∏—Ç–µ.');
                return;
            }
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                try {
                    const user = auth.currentUser;
                    if (!user) throw new Error('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    
                    await user.revokeRefreshTokens();
                    await db.collection('users').doc(currentUser.uid).delete();
                    await user.delete();
                    
                    logout();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
                }
            }
        }

        // ==================== –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø ====================
        function setPartColor(part, color, element) {
            playerColors[part] = color;
            const parentPicker = element.parentNode;
            Array.from(parentPicker.children).forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            updateAllAvatars();
            if (currentUser && !currentUser.isGuest && currentUser.uid) {
                db.collection('users').doc(currentUser.uid).update({ colors: playerColors })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞:', error);
                        if (error.code === 'permission-denied' || error.code === 'unauthenticated' || error.message.includes('permission')) {
                            alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                            logout();
                        }
                    });
            }
        }

        function updateAllAvatars() {
            const avatars = document.querySelectorAll('#sidebar-avatar, #profile-avatar, #customize-avatar');
            avatars.forEach(avatar => {
                avatar.style.backgroundColor = playerColors.body;
                avatar.style.color = 'white';
            });
        }

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–†–ê–ù–ò–¶–ê–ú–ò ====================
        function switchPage(page) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const titles = {
                'home': '–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞',
                'profile': '–ü—Ä–æ—Ñ–∏–ª—å',
                'avatar': '–ê–≤–∞—Ç–∞—Ä',
                'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                'friends': '–î—Ä—É–∑—å—è'
            };
            document.getElementById('page-title').textContent = titles[page];
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById(page + '-section').classList.add('active');
        }

        function selectGame() {
            document.querySelector('.game-card-large').classList.add('selected');
        }

        // ==================== –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫—Ä–æ–º–µ —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) ====================
        let peer = null;
        let connections = new Map();
        let otherPlayers = new Map();
        let myPeerId = null;
        const ROOM_ID = 'yourblocks_global_room';

        function debugLog(msg) {
            console.log('[MULTIPLAYER]', msg);
            const panel = document.getElementById('debug-panel');
            panel.style.display = 'block';
            panel.innerHTML = msg;
            setTimeout(() => { panel.style.display = 'none'; }, 5000);
        }

        function initMultiplayer() {
            return new Promise((resolve) => {
                try {
                    peer = new Peer(ROOM_ID, {
                        host: '0.peerjs.com',
                        port: 443,
                        secure: true,
                        debug: 2
                    });
                    peer.on('open', (id) => {
                        myPeerId = id;
                        debugLog(`‚úÖ –Ø —Ö–æ—Å—Ç, ID: ${id}`);
                        document.getElementById('server-status').textContent = 'üü¢ –•–û–°–¢ –ö–û–ú–ù–ê–¢–´';
                        peer.on('connection', (conn) => handleConnection(conn));
                        resolve();
                    });
                    peer.on('error', (err) => {
                        console.error('PeerJS error:', err);
                        if (err.type === 'unavailable-id') {
                            debugLog('üü° –ö–æ–º–Ω–∞—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ–¥–∫–ª—é—á–∞—é—Å—å –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç...');
                            peer = new Peer({
                                host: '0.peerjs.com',
                                port: 443,
                                secure: true,
                                debug: 2
                            });
                            peer.on('open', (id) => {
                                myPeerId = id;
                                debugLog(`‚úÖ –Ø –∫–ª–∏–µ–Ω—Ç, –º–æ–π ID: ${id}`);
                                document.getElementById('server-status').textContent = 'üü¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ö–û–ú–ù–ê–¢–ï...';
                                const conn = peer.connect(ROOM_ID);
                                if (conn) handleConnection(conn);
                                else debugLog('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ö–æ—Å—Ç—É');
                                peer.on('connection', (conn) => handleConnection(conn));
                                resolve();
                            });
                            peer.on('error', (e) => {
                                debugLog('‚ùå –û—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞: ' + e);
                                resolve();
                            });
                        } else {
                            debugLog('‚ùå –û—à–∏–±–∫–∞ PeerJS: ' + err.type);
                            document.getElementById('server-status').textContent = 'üî¥ –û–§–§–õ–ê–ô–ù';
                            resolve();
                        }
                    });
                } catch (e) {
                    debugLog('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + e);
                    resolve();
                }
            });
        }

        function handleConnection(conn) {
            const peerId = conn.peer;
            debugLog(`üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerId}`);
            conn.on('open', () => {
                debugLog(`‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å ${peerId}`);
                connections.set(peerId, conn);
                updatePlayersCount();
                sendMyInfo(conn);
                conn.on('data', (data) => handleData(peerId, data));
                conn.on('close', () => {
                    debugLog(`üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ —Å ${peerId}`);
                    connections.delete(peerId);
                    removeOtherPlayer(peerId);
                    updatePlayersCount();
                });
                conn.on('error', (err) => console.error('Connection error:', err));
            });
        }

        function sendMyInfo(conn) {
            if (!localPlayerBody) return;
            conn.send({
                type: 'init',
                username: currentUser ? currentUser.username : '–ò–≥—Ä–æ–∫',
                x: localPlayerBody.position.x,
                y: localPlayerBody.position.y,
                z: localPlayerBody.position.z,
                headColor: playerColors.head,
                bodyColor: playerColors.body,
                legsColor: playerColors.legs,
                armsColor: playerColors.arms
            });
        }

        function handleData(peerId, data) {
            if (data.type === 'init') {
                if (!otherPlayers.has(peerId)) {
                    const model = createMultiplayerModel(data);
                    if (model && scene) {
                        model.position.set(data.x, data.y, data.z);
                        scene.add(model);
                        otherPlayers.set(peerId, {
                            model: model,
                            targetPos: new THREE.Vector3(data.x, data.y, data.z),
                            username: data.username
                        });
                        debugLog(`üë§ –î–æ–±–∞–≤–ª–µ–Ω –∏–≥—Ä–æ–∫ ${data.username}`);
                        updatePlayersCount();
                    }
                }
            } else if (data.type === 'position') {
                if (otherPlayers.has(peerId)) {
                    const player = otherPlayers.get(peerId);
                    player.targetPos.set(data.x, data.y, data.z);
                }
            }
        }

        function broadcastPosition() {
            if (!localPlayerBody || connections.size === 0) return;
            const data = {
                type: 'position',
                x: localPlayerBody.position.x,
                y: localPlayerBody.position.y,
                z: localPlayerBody.position.z
            };
            connections.forEach((conn) => {
                if (conn.open) conn.send(data);
            });
        }

        function removeOtherPlayer(id) {
            if (otherPlayers.has(id)) {
                const player = otherPlayers.get(id);
                if (player.model && scene) scene.remove(player.model);
                otherPlayers.delete(id);
                updatePlayersCount();
            }
        }

        function updatePlayersCount() {
            const count = otherPlayers.size + 1;
            document.getElementById('players-count').textContent = `üë• ${count} –≤ –∫–æ–º–Ω–∞—Ç–µ`;
            document.getElementById('global-online').textContent = count;
            document.getElementById('game-players').textContent = count;
        }

        function createMultiplayerModel(data) {
            try {
                const group = new THREE.Group();
                function getMaterial(hex) { return new THREE.MeshStandardMaterial({ color: hex }); }
                const torso = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2, 0.8), getMaterial(data.bodyColor));
                torso.position.y = 1.6; torso.castShadow = true; group.add(torso);
                const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), getMaterial(data.headColor));
                head.position.y = 3; head.castShadow = true; group.add(head);
                const leftLeg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.8, 0.7), getMaterial(data.legsColor));
                leftLeg.position.set(-0.4, 0.2, 0); leftLeg.castShadow = true; group.add(leftLeg);
                const rightLeg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.8, 0.7), getMaterial(data.legsColor));
                rightLeg.position.set(0.4, 0.2, 0); rightLeg.castShadow = true; group.add(rightLeg);
                const leftArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.8, 0.5), getMaterial(data.armsColor));
                leftArm.position.set(-0.8, 1.8, 0); leftArm.castShadow = true; group.add(leftArm);
                const rightArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.8, 0.5), getMaterial(data.armsColor));
                rightArm.position.set(0.8, 1.8, 0); rightArm.castShadow = true; group.add(rightArm);
                return group;
            } catch (e) { return null; }
        }

        function manualConnect() {
            // –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø—É—Å—Ç–æ–π, —Ç–∞–∫ –∫–∞–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–∫—Ä—ã—Ç
        }

        // ==================== –û–°–ù–û–í–ù–ê–Ø –ò–ì–†–ê (Three.js + Cannon) ====================
        let scene, camera, renderer, yawObject, pitchObject, world;
        let localPlayerBody, localModel;
        let keys = {}, jumpPressed = false, spaceKeyDown = false;
        let deathBlocks = [];
        let walkTime = 0;
        let joystickActive = false;
        let joystickVector = { x: 0, y: 0 };
        let jumpButtonPressed = false;
        let cameraTouchActive = false;
        let lastTouchX = 0, lastTouchY = 0;

        function animatePlayer(model, walkTimeVal, isMoving) {
            if (!model || model.children.length < 6) return;
            const leftLeg = model.children[2];
            const rightLeg = model.children[3];
            const leftArm = model.children[4];
            const rightArm = model.children[5];
            if (isMoving) {
                const swing = Math.sin(walkTimeVal) * 0.7;
                leftLeg.rotation.x = swing;
                rightLeg.rotation.x = -swing;
                leftArm.rotation.x = -swing;
                rightArm.rotation.x = swing;
            } else {
                leftLeg.rotation.x = 0;
                rightLeg.rotation.x = 0;
                leftArm.rotation.x = 0;
                rightArm.rotation.x = 0;
            }
        }

        function createCustomPlayerModel() {
            const group = new THREE.Group();
            function getMaterial(hex) { return new THREE.MeshStandardMaterial({ color: hex }); }
            const torso = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2, 0.8), getMaterial(playerColors.body));
            torso.position.y = 1.6; torso.castShadow = true; group.add(torso);
            const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), getMaterial(playerColors.head));
            head.position.y = 3; head.castShadow = true; group.add(head);
            const leftLeg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.8, 0.7), getMaterial(playerColors.legs));
            leftLeg.position.set(-0.4, 0.2, 0); leftLeg.castShadow = true; group.add(leftLeg);
            const rightLeg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.8, 0.7), getMaterial(playerColors.legs));
            rightLeg.position.set(0.4, 0.2, 0); rightLeg.castShadow = true; group.add(rightLeg);
            const leftArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.8, 0.5), getMaterial(playerColors.arms));
            leftArm.position.set(-0.8, 1.8, 0); leftArm.castShadow = true; group.add(leftArm);
            const rightArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.8, 0.5), getMaterial(playerColors.arms));
            rightArm.position.set(0.8, 1.8, 0); rightArm.castShadow = true; group.add(rightArm);
            return group;
        }

        function isOnGround() {
            return Math.abs(localPlayerBody.velocity.y) < 0.1;
        }

        function initThreeJSGame(container) {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            yawObject = new THREE.Object3D();
            pitchObject = new THREE.Object3D();
            yawObject.add(pitchObject);
            pitchObject.add(camera);
            scene.add(yawObject);
            let cameraDistance = 8;
            camera.position.set(0, 3, cameraDistance);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
            dirLight.position.set(20, 30, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            world = new CANNON.World();
            world.gravity.set(0, -9.82, 0);
            const groundMaterial = new CANNON.Material("groundMaterial");
            const playerMaterial = new CANNON.Material("playerMaterial");
            const contactMaterial = new CANNON.ContactMaterial(playerMaterial, groundMaterial, { friction: 0.0, restitution: 0.0 });
            world.addContactMaterial(contactMaterial);
            world.defaultContactMaterial = contactMaterial;

            deathBlocks = [];

            // ==================== –£–†–û–í–ï–ù–¨ (–∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö) ====================
            function createLevel() {
                const groundMesh = new THREE.Mesh(
                    new THREE.BoxGeometry(80, 2, 80),
                    new THREE.MeshStandardMaterial({ color: 0x2a3a4a })
                );
                groundMesh.position.set(0, -1, 0);
                groundMesh.receiveShadow = true;
                scene.add(groundMesh);
                const groundBody = new CANNON.Body({ mass: 0, material: groundMaterial });
                groundBody.addShape(new CANNON.Box(new CANNON.Vec3(40, 1, 40)));
                groundBody.position.copy(groundMesh.position);
                world.addBody(groundBody);

                const mazeStartX = 15;
                const mazeStartZ = -20;
                const wallPositions = [
                    [mazeStartX, 2, mazeStartZ, 20, 4, 1],
                    [mazeStartX + 20, 2, mazeStartZ, 1, 4, 20],
                    [mazeStartX, 2, mazeStartZ - 10, 20, 4, 1],
                    [mazeStartX, 2, mazeStartZ + 10, 20, 4, 1],
                    [mazeStartX + 5, 2, mazeStartZ - 5, 1, 4, 8],
                    [mazeStartX + 10, 2, mazeStartZ + 2, 1, 4, 8],
                    [mazeStartX + 15, 2, mazeStartZ - 3, 1, 4, 8],
                    [mazeStartX + 8, 2, mazeStartZ + 5, 8, 4, 1],
                    [mazeStartX + 12, 2, mazeStartZ - 7, 8, 4, 1],
                ];
                wallPositions.forEach(pos => {
                    const wallMesh = new THREE.Mesh(
                        new THREE.BoxGeometry(pos[3], pos[4], pos[5]),
                        new THREE.MeshStandardMaterial({ color: 0x8B4513 })
                    );
                    wallMesh.position.set(pos[0], pos[1], pos[2]);
                    wallMesh.castShadow = true;
                    wallMesh.receiveShadow = true;
                    scene.add(wallMesh);
                    const wallBody = new CANNON.Body({ mass: 0, material: groundMaterial });
                    wallBody.addShape(new CANNON.Box(new CANNON.Vec3(pos[3]/2, pos[4]/2, pos[5]/2)));
                    wallBody.position.copy(wallMesh.position);
                    world.addBody(wallBody);
                });

                const entranceMesh = new THREE.Mesh(
                    new THREE.BoxGeometry(2, 1, 2),
                    new THREE.MeshStandardMaterial({ color: 0x4CAF50 })
                );
                entranceMesh.position.set(mazeStartX + 2, 0.5, mazeStartZ - 5);
                entranceMesh.castShadow = true;
                entranceMesh.receiveShadow = true;
                scene.add(entranceMesh);

                for (let i = 0; i < 5; i++) {
                    const deathMesh = new THREE.Mesh(
                        new THREE.BoxGeometry(1.5, 0.5, 1.5),
                        new THREE.MeshStandardMaterial({ color: 0xff3333, emissive: 0x330000 })
                    );
                    deathMesh.position.set(mazeStartX + 5 + i*3, 0.5, mazeStartZ - 2);
                    deathMesh.castShadow = true;
                    deathMesh.receiveShadow = true;
                    scene.add(deathMesh);
                    const deathBody = new CANNON.Body({ mass: 0, material: groundMaterial, collisionResponse: false });
                    deathBody.addShape(new CANNON.Box(new CANNON.Vec3(0.75, 0.25, 0.75)));
                    deathBody.position.copy(deathMesh.position);
                    world.addBody(deathBody);
                    deathBlocks.push(deathBody);
                }

                for (let i = 0; i < 20; i++) {
                    const platformMesh = new THREE.Mesh(
                        new THREE.BoxGeometry(3, 0.5, 3),
                        new THREE.MeshStandardMaterial({ color: new THREE.Color().setHSL(i / 20, 0.8, 0.5) })
                    );
                    let x, z;
                    if (i < 10) {
                        x = -10;
                        z = -10 - i * 6;
                    } else {
                        x = -15 + Math.sin(i) * 8;
                        z = -70 - (i-10) * 5;
                    }
                    platformMesh.position.set(x, 1 + i * 1.5, z);
                    platformMesh.castShadow = true;
                    platformMesh.receiveShadow = true;
                    scene.add(platformMesh);
                    const platformBody = new CANNON.Body({ mass: 0, material: groundMaterial });
                    platformBody.addShape(new CANNON.Box(new CANNON.Vec3(1.5, 0.25, 1.5)));
                    platformBody.position.copy(platformMesh.position);
                    world.addBody(platformBody);
                    if (i % 3 === 0 && i > 5) {
                        const deathMesh = new THREE.Mesh(
                            new THREE.BoxGeometry(1.2, 0.5, 1.2),
                            new THREE.MeshStandardMaterial({ color: 0xff3333, emissive: 0x330000 })
                        );
                        deathMesh.position.set(platformMesh.position.x + 1, 1.8, platformMesh.position.z);
                        deathMesh.castShadow = true;
                        deathMesh.receiveShadow = true;
                        scene.add(deathMesh);
                        const deathBody = new CANNON.Body({ mass: 0, material: groundMaterial, collisionResponse: false });
                        deathBody.addShape(new CANNON.Box(new CANNON.Vec3(0.6, 0.25, 0.6)));
                        deathBody.position.copy(deathMesh.position);
                        world.addBody(deathBody);
                        deathBlocks.push(deathBody);
                    }
                }

                const finishMesh = new THREE.Mesh(
                    new THREE.BoxGeometry(5, 0.5, 5),
                    new THREE.MeshStandardMaterial({ color: 0xffaa00, emissive: 0x442200 })
                );
                finishMesh.position.set(0, 0.5, -150);
                finishMesh.castShadow = true;
                finishMesh.receiveShadow = true;
                scene.add(finishMesh);
            }

            createLevel();

            localPlayerBody = new CANNON.Body({
                mass: 5,
                material: playerMaterial,
                linearDamping: 0.0,
                angularDamping: 0.0,
                fixedRotation: true
            });
            localPlayerBody.addShape(new CANNON.Sphere(0.9));
            localPlayerBody.position.set(0, 5, 10);
            world.addBody(localPlayerBody);

            localModel = createCustomPlayerModel();
            scene.add(localModel);

            // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
            keys = {};
            jumpPressed = false;
            spaceKeyDown = false;

            document.addEventListener("keydown", (e) => {
                keys[e.code] = true;
                if (e.code === "Space" && !spaceKeyDown) {
                    jumpPressed = true;
                    spaceKeyDown = true;
                }
            });
            document.addEventListener("keyup", (e) => {
                keys[e.code] = false;
                if (e.code === "Space") {
                    spaceKeyDown = false;
                }
            });

            let mouseDown = false;
            document.addEventListener("mousedown", (e) => {
                if (e.button === 2) mouseDown = true;
            });
            document.addEventListener("mouseup", (e) => {
                if (e.button === 2) mouseDown = false;
            });
            document.addEventListener("mousemove", (e) => {
                if (!mouseDown) return;
                yawObject.rotation.y -= e.movementX * 0.002;
                pitchObject.rotation.x -= e.movementY * 0.002;
                pitchObject.rotation.x = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, pitchObject.rotation.x));
            });

            const spawnPosition = new CANNON.Vec3(0, 5, 10);
            const deathHeight = -10;
            const groundIndicator = document.getElementById('ground-indicator');

            walkTime = 0;
            let lastSendTime = 0;

            function animate() {
                requestAnimationFrame(animate);
                const delta = 0.016;
                world.step(1 / 60, delta, 3);

                // –°–º–µ—Ä—Ç—å
                let dead = false;
                if (localPlayerBody.position.y < deathHeight) dead = true;
                if (!dead) {
                    const playerPos = localPlayerBody.position;
                    const playerRadius = 0.9;
                    for (let block of deathBlocks) {
                        const blockPos = block.position;
                        const dx = playerPos.x - blockPos.x;
                        const dy = playerPos.y - blockPos.y;
                        const dz = playerPos.z - blockPos.z;
                        const distance = Math.sqrt(dx*dx + dy*dy + dz*dz);
                        if (distance < playerRadius + 1.0) { dead = true; break; }
                    }
                }
                if (dead) {
                    localPlayerBody.position.copy(spawnPosition);
                    localPlayerBody.velocity.set(0, 0, 0);
                }

                // –î–≤–∏–∂–µ–Ω–∏–µ
                const moveSpeed = 12;
                let moveX = 0, moveZ = 0;
                if (keys["KeyW"]) moveZ += 1;
                if (keys["KeyS"]) moveZ -= 1;
                if (keys["KeyA"]) moveX -= 1;
                if (keys["KeyD"]) moveX += 1;
                if (joystickActive) {
                    moveX += joystickVector.x;
                    moveZ += -joystickVector.y;
                }

                const onGround = isOnGround();

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä (—Ö–æ—Ç—è –æ–Ω —Å–∫—Ä—ã—Ç)
                if (groundIndicator) {
                    groundIndicator.textContent = onGround ? 'üü¢ –ù–ê –ó–ï–ú–õ–ï' : 'üî¥ –í –í–û–ó–î–£–•–ï';
                    groundIndicator.classList.toggle('onground', onGround);
                    groundIndicator.classList.toggle('air', !onGround);
                }

                // –¢–æ–ª—å–∫–æ –Ω–∞ –∑–µ–º–ª–µ –º–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –¥–≤–∏–∂–µ–Ω–∏—è
                if (onGround) {
                    if (moveX !== 0 || moveZ !== 0) {
                        const len = Math.sqrt(moveX*moveX + moveZ*moveZ);
                        moveX /= len; moveZ /= len;
                        localModel.rotation.y = Math.atan2(moveX, moveZ);
                    }
                    const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(yawObject.quaternion);
                    const right = new THREE.Vector3(1, 0, 0).applyQuaternion(yawObject.quaternion);
                    forward.y = 0; right.y = 0;
                    forward.normalize(); right.normalize();
                    localPlayerBody.velocity.x = (forward.x * moveZ + right.x * moveX) * moveSpeed;
                    localPlayerBody.velocity.z = (forward.z * moveZ + right.z * moveX) * moveSpeed;
                } else {
                    // –í –≤–æ–∑–¥—É—Ö–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
                }

                if ((jumpPressed || jumpButtonPressed) && onGround) {
                    localPlayerBody.velocity.y = 10;
                    jumpPressed = false;
                    jumpButtonPressed = false;
                    document.getElementById('jump-button').classList.remove('active');
                }

                // –ê–Ω–∏–º–∞—Ü–∏—è
                const moving = onGround && (Math.abs(localPlayerBody.velocity.x) > 0.1 || Math.abs(localPlayerBody.velocity.z) > 0.1);
                if (moving) walkTime += delta * 12;
                animatePlayer(localModel, walkTime, moving);

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º
                if (connections.size > 0) {
                    const now = Date.now();
                    if (now - lastSendTime > 100) {
                        broadcastPosition();
                        lastSendTime = now;
                    }
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
                otherPlayers.forEach((player) => {
                    if (player.model && player.targetPos) {
                        player.model.position.lerp(player.targetPos, 0.3);
                    }
                });

                // –ö–∞–º–µ—Ä–∞
                camera.position.set(0, 3, cameraDistance);
                localModel.position.copy(localPlayerBody.position);
                yawObject.position.copy(localPlayerBody.position);

                renderer.render(scene, camera);
            }

            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ==================== –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
        function initMobileControls() {
            const leftArea = document.getElementById('left-area');
            const rightArea = document.getElementById('right-area');
            const joystick = document.getElementById('joystick-left');
            const handle = document.getElementById('joystick-handle');
            const jumpBtn = document.getElementById('jump-button');

            leftArea.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                updateJoystick(e.touches[0]);
            });
            leftArea.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) updateJoystick(e.touches[0]);
            });
            leftArea.addEventListener('touchend', (e) => {
                e.preventDefault();
                joystickActive = false;
                joystickVector = { x: 0, y: 0 };
                handle.style.transform = 'translate(0px, 0px)';
            });

            function updateJoystick(touch) {
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                let dx = touch.clientX - centerX;
                let dy = touch.clientY - centerY;
                const distance = Math.sqrt(dx*dx + dy*dy);
                const maxDistance = rect.width / 2;
                if (distance > maxDistance) {
                    dx = (dx / distance) * maxDistance;
                    dy = (dy / distance) * maxDistance;
                }
                handle.style.transform = `translate(${dx}px, ${dy}px)`;
                joystickVector.x = dx / maxDistance;
                joystickVector.y = dy / maxDistance;
            }

            rightArea.addEventListener('touchstart', (e) => {
                e.preventDefault();
                cameraTouchActive = true;
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
            });
            rightArea.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (cameraTouchActive && yawObject) {
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - lastTouchX;
                    const deltaY = touch.clientY - lastTouchY;
                    yawObject.rotation.y -= deltaX * 0.005;
                    if (pitchObject) {
                        pitchObject.rotation.x -= deltaY * 0.003;
                        pitchObject.rotation.x = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, pitchObject.rotation.x));
                    }
                    lastTouchX = touch.clientX;
                    lastTouchY = touch.clientY;
                }
            });
            rightArea.addEventListener('touchend', (e) => {
                e.preventDefault();
                cameraTouchActive = false;
            });

            jumpBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                jumpButtonPressed = true;
                jumpBtn.classList.add('active');
            });
            jumpBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                jumpButtonPressed = false;
                jumpBtn.classList.remove('active');
            });
        }

        async function startGame() {
            if (!currentUser?.isGuest) {
                try {
                    if (!auth.currentUser) {
                        throw new Error('Not authenticated');
                    }
                    await auth.currentUser.getIdToken(true);
                } catch (e) {
                    alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                    logout();
                    return;
                }
            }

            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('game-container').classList.add('active');
            if (window.innerWidth <= 768) document.getElementById('mobile-controls').classList.add('active');

            await initMultiplayer();
            initThreeJSGame(document.getElementById('game-canvas'));
            initMobileControls();
        }

        function exitGame() {
            if (peer) peer.destroy();
            document.getElementById('menu-container').style.display = 'flex';
            document.getElementById('game-container').classList.remove('active');
            document.getElementById('mobile-controls').classList.remove('active');
            document.getElementById('game-canvas').innerHTML = '';
            if (window.gameAnimation) {
                cancelAnimationFrame(window.gameAnimation);
                window.gameAnimation = null;
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const gameContainer = document.getElementById('game-container');
                if (gameContainer.classList.contains('active')) exitGame();
            }
        });

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
        window.addEventListener('load', () => {
            // –ü—Ä–æ–≤–µ—Ä–∏–º, –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–∫—Ç–∏–≤–µ–Ω –≤—Ö–æ–¥)
            if (document.getElementById('register-form').classList.contains('active')) {
                refreshSuggestions();
            }
        });
    </script>
</body>
</html>
