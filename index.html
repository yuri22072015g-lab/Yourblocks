<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Yourblocks ‚Äî –ù–∞–¥—ë–∂–Ω—ã–π –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* –í—Å–µ –≤–∞—à–∏ –∏—Å—Ö–æ–¥–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Roboto', sans-serif; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { overflow: hidden; background: #141414; touch-action: none; }
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e, #16213e); z-index: 2000; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .login-container { background: rgba(30, 30, 40, 0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 30px; width: 90%; max-width: 400px; border: 2px solid #4CAF50; box-shadow: 0 0 50px rgba(76, 175, 80, 0.3); animation: slideUp 0.5s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .login-logo { text-align: center; font-size: 48px; margin-bottom: 20px; color: #4CAF50; }
        .login-title { text-align: center; font-size: 32px; font-weight: bold; margin-bottom: 10px; color: white; }
        .login-subtitle { text-align: center; color: #888; margin-bottom: 30px; font-size: 14px; }
        .login-tabs { display: flex; gap: 10px; margin-bottom: 30px; background: rgba(0, 0, 0, 0.3); padding: 5px; border-radius: 50px; }
        .login-tab { flex: 1; padding: 12px; text-align: center; border-radius: 40px; cursor: pointer; transition: all 0.3s; color: #888; font-weight: bold; }
        .login-tab.active { background: #4CAF50; color: white; }
        .login-form { display: none; }
        .login-form.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; color: #888; margin-bottom: 8px; font-size: 14px; }
        .input-group input { width: 100%; padding: 15px; background: rgba(0, 0, 0, 0.3); border: 2px solid #333; border-radius: 15px; color: white; font-size: 16px; transition: all 0.3s; }
        .input-group input:focus { outline: none; border-color: #4CAF50; }
        .login-btn { width: 100%; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-bottom: 15px; }
        .login-btn:hover { transform: scale(1.02); background: #45a049; }
        .guest-btn { width: 100%; padding: 15px; background: transparent; color: #888; border: 2px solid #333; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .guest-btn:hover { border-color: #4CAF50; color: white; }
        .error-message { color: #ff5555; font-size: 14px; margin-top: 10px; text-align: center; display: none; }
        .suggested-nicks { margin-top: 20px; text-align: center; }
        .suggested-nicks p { color: #888; margin-bottom: 10px; font-size: 14px; }
        .nick-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .nick-btn { background: #2a2a2a; border: 2px solid #4CAF50; color: white; padding: 8px 15px; border-radius: 30px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .nick-btn:hover { background: #4CAF50; transform: scale(1.05); }
        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (–º–µ–Ω—é, –∏–≥—Ä–∞) ‚Äì –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –ø–æ–ª–Ω—ã–π –∫–æ–¥ –∏–∑ –≤–∞—à–µ–≥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ */
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">üß±</div>
            <div class="login-title">YOURBLOCKS</div>
            <div class="login-subtitle">–í–æ–π–¥–∏, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>
            <div class="login-tabs">
                <div class="login-tab active" onclick="switchLoginTab('login')">–í—Ö–æ–¥</div>
                <div class="login-tab" onclick="switchLoginTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            </div>
            <div id="login-form" class="login-form active">
                <div class="input-group">
                    <label>üë§ –õ–æ–≥–∏–Ω</label>
                    <input type="text" id="login-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="input-group">
                    <label>üîí –ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="login-btn" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
                <button class="guest-btn" onclick="handleGuest()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ –≥–æ—Å—Ç—å</button>
                <div id="login-error" class="error-message"></div>
            </div>
            <div id="register-form" class="login-form">
                <div class="input-group">
                    <label>üë§ –õ–æ–≥–∏–Ω</label>
                    <input type="text" id="register-username" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="input-group">
                    <label>üîí –ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="register-password" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="input-group">
                    <label>üîí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</label>
                    <input type="password" id="register-confirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="login-btn" onclick="handleRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button class="guest-btn" onclick="handleGuest()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ –≥–æ—Å—Ç—å</button>
                <div id="register-error" class="error-message"></div>
                <div class="suggested-nicks">
                    <p>üî• –°–≤–æ–±–æ–¥–Ω—ã–µ –Ω–∏–∫–∏:</p>
                    <div class="nick-buttons" id="suggested-nicks-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Äì –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –ø–æ–ª–Ω—ã–π –∫–æ–¥ –º–µ–Ω—é -->
    <div id="menu-container">
        <!-- ... -->
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äì –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –ø–æ–ª–Ω—ã–π –∫–æ–¥ –∏–≥—Ä—ã -->
    <div id="game-container">
        <!-- ... -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>

    <script>
        // ==================== FIREBASE –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCMgDxuPbye5rpZcS7JAHD_6PEDbAc3ZdU",
            authDomain: "yourblocks-ccdb7.firebaseapp.com",
            projectId: "yourblocks-ccdb7",
            storageBucket: "yourblocks-ccdb7.firebasestorage.app",
            messagingSenderId: "531017606276",
            appId: "1:531017606276:web:5eab2f87a2f9f5c885ced1",
            measurementId: "G-JSWF0QVSJ9"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentUser = null;
        let playerColors = { head: '#ffccaa', body: '#3366ff', legs: '#2244aa', arms: '#2244aa' };
        let sessionListener = null;

        function nickToEmail(nick) {
            return nick.trim().toLowerCase().replace(/\s+/g, '') + '@yourblocks-ccdb7.firebaseapp.com';
        }

        // ==================== –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–í–û–ë–û–î–ù–´–• –ù–ò–ö–û–í ====================
        async function generateRandomNick() {
            const adjectives = ['–•—Ä–∞–±—Ä—ã–π', '–ë—ã—Å—Ç—Ä—ã–π', '–°–º–µ–ª—ã–π', '–¢–∏—Ö–∏–π', '–ó–æ—Ä–∫–∏–π', '–õ–æ–≤–∫–∏–π', '–ú—É–¥—Ä—ã–π', '–í–µ—Å–µ–ª—ã–π', '–î–∏–∫–∏–π', '–•–∏—Ç—Ä—ã–π'];
            const nouns = ['–í–æ–ª–∫', '–õ–∏—Å', '–ú–µ–¥–≤–µ–¥—å', '–û—Ä–µ–ª', '–¢–∏–≥—Ä', '–õ–µ–≤', '–°–æ–∫–æ–ª', '–î—Ä–∞–∫–æ–Ω', '–§–µ–Ω–∏–∫—Å', '–†—ã—Å—å'];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const num = Math.floor(Math.random() * 1000);
            return adj + noun + num;
        }

        async function getFreeNicks(count = 3) {
            const freeNicks = [];
            const usedNicks = new Set();
            const snapshot = await db.collection('users').get();
            snapshot.forEach(doc => usedNicks.add(doc.data().username));
            while (freeNicks.length < count) {
                const candidate = await generateRandomNick();
                if (!usedNicks.has(candidate) && !freeNicks.includes(candidate)) {
                    freeNicks.push(candidate);
                }
            }
            return freeNicks;
        }

        async function updateSuggestedNicks() {
            const container = document.getElementById('suggested-nicks-container');
            if (!container) return;
            const nicks = await getFreeNicks(3);
            container.innerHTML = '';
            nicks.forEach(nick => {
                const btn = document.createElement('button');
                btn.className = 'nick-btn';
                btn.textContent = nick;
                btn.onclick = () => {
                    document.getElementById('register-username').value = nick;
                };
                container.appendChild(btn);
            });
        }

        window.addEventListener('load', updateSuggestedNicks);

        // ==================== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö ====================
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            document.getElementById(tab + '-form').classList.add('active');
            if (tab === 'register') updateSuggestedNicks();
        }

        // ==================== –í–•–û–î ====================
        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorDiv = document.getElementById('login-error');
            if (!username || !password) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorDiv.style.display = 'block';
                return;
            }
            const email = nickToEmail(username);
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    currentUser = { uid: user.uid, username, ...doc.data() };
                } else {
                    currentUser = {
                        uid: user.uid,
                        username,
                        level: 1,
                        games: 0,
                        colors: { head: '#ffccaa', body: '#3366ff', legs: '#2244aa', arms: '#2244aa' },
                        friends: {},
                        friendRequests: {}
                    };
                    await db.collection('users').doc(user.uid).set(currentUser);
                }
                const sessionId = Math.random().toString(36).substring(2) + Date.now();
                await db.collection('users').doc(user.uid).update({ sessionId });
                currentUser.sessionId = sessionId;

                if (sessionListener) sessionListener();
                sessionListener = db.collection('users').doc(user.uid).onSnapshot((docSnapshot) => {
                    if (docSnapshot.exists) {
                        const data = docSnapshot.data();
                        if (data.sessionId && data.sessionId !== currentUser.sessionId) {
                            alert('–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—ã –≤–æ—à–ª–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Å—Ä–æ—á–Ω–æ –ø–æ–º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–æ–ª—å!');
                            logout();
                        }
                    } else {
                        alert('–ê–∫–∫–∞—É–Ω—Ç –±—ã–ª —É–¥–∞–ª—ë–Ω.');
                        logout();
                    }
                });

                if (currentUser.colors) playerColors = currentUser.colors;
                updateAllAvatars();
                loginSuccess();
            } catch (error) {
                console.error(error);
                let message = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ';
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    message = '–≠—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ';
                } else if (error.code === 'auth/invalid-email') {
                    message = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∏–∫';
                } else if (error.code === 'auth/too-many-requests') {
                    message = '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                } else {
                    message = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                }
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        // ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ====================
        async function handleRegister() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const confirm = document.getElementById('register-confirm').value.trim();
            const errorDiv = document.getElementById('register-error');
            if (!username || !password || !confirm) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                errorDiv.style.display = 'block';
                return;
            }
            if (password !== confirm) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                errorDiv.style.display = 'block';
                return;
            }
            if (password.length < 6) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                errorDiv.style.display = 'block';
                return;
            }
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                errorDiv.textContent = '–õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ';
                errorDiv.style.display = 'block';
                return;
            }
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞
            const snapshot = await db.collection('users').where('username', '==', username).get();
            if (!snapshot.empty) {
                errorDiv.textContent = '–ê–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º –Ω–∏–∫–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π.';
                errorDiv.style.display = 'block';
                return;
            }

            const email = nickToEmail(username);
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const newUser = {
                    username,
                    level: 1,
                    games: 0,
                    colors: { head: '#ffccaa', body: '#3366ff', legs: '#2244aa', arms: '#2244aa' },
                    friends: {},
                    friendRequests: {},
                    created: Date.now()
                };
                await db.collection('users').doc(user.uid).set(newUser);
                const sessionId = Math.random().toString(36).substring(2) + Date.now();
                await db.collection('users').doc(user.uid).update({ sessionId });
                newUser.sessionId = sessionId;
                currentUser = { uid: user.uid, ...newUser };
                playerColors = newUser.colors;

                if (sessionListener) sessionListener();
                sessionListener = db.collection('users').doc(user.uid).onSnapshot((docSnapshot) => {
                    if (docSnapshot.exists) {
                        const data = docSnapshot.data();
                        if (data.sessionId && data.sessionId !== currentUser.sessionId) {
                            alert('–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—ã –≤–æ—à–ª–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Å—Ä–æ—á–Ω–æ –ø–æ–º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–æ–ª—å!');
                            logout();
                        }
                    } else {
                        alert('–ê–∫–∫–∞—É–Ω—Ç –±—ã–ª —É–¥–∞–ª—ë–Ω.');
                        logout();
                    }
                });

                updateAllAvatars();
                loginSuccess();
            } catch (error) {
                console.error(error);
                let message = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                if (error.code === 'auth/email-already-in-use') {
                    message = '–≠—Ç–æ—Ç email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–∏–∫ –∑–∞–Ω—è—Ç)';
                } else {
                    message = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                }
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function handleGuest() {
            currentUser = {
                username: '–ì–æ—Å—Ç—å_' + Math.floor(Math.random() * 10000),
                level: 1,
                games: 0,
                isGuest: true,
                colors: playerColors
            };
            loginSuccess();
        }

        function loginSuccess() {
            document.getElementById('sidebar-username').textContent = currentUser.username;
            document.getElementById('profile-username').textContent = currentUser.username;
            if (currentUser.isGuest) {
                document.getElementById('sidebar-status').innerHTML = 'üë§ <span>–ì–æ—Å—Ç—å</span>';
            } else {
                document.getElementById('sidebar-status').innerHTML = (currentUser.level || 1) + ' <span>–ë–ª–∏–∑–∫–∏–π</span>';
                document.getElementById('profile-friends-count').textContent = currentUser.friends ? Object.keys(currentUser.friends).length : 0;
            }
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('menu-container').style.display = 'flex';
            }, 500);
        }

        async function logout() {
            if (sessionListener) {
                sessionListener();
                sessionListener = null;
            }
            if (!currentUser?.isGuest && currentUser?.uid) {
                if (currentUser.colors) currentUser.colors = playerColors;
                try {
                    await db.collection('users').doc(currentUser.uid).update({ colors: playerColors });
                } catch (e) { console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', e); }
            }
            await auth.signOut();
            currentUser = null;
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-screen').style.opacity = '1';
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('register-username').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-confirm').value = '';
        }

        async function deleteAccount() {
            if (!currentUser) return;
            if (currentUser.isGuest) {
                alert('–ì–æ—Å—Ç–∏ –Ω–µ –º–æ–≥—É—Ç —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç. –ü—Ä–æ—Å—Ç–æ –≤—ã–π–¥–∏—Ç–µ.');
                return;
            }
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                try {
                    const user = auth.currentUser;
                    if (!user) throw new Error('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    await user.revokeRefreshTokens();
                    await db.collection('users').doc(currentUser.uid).delete();
                    await user.delete();
                    logout();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
                }
            }
        }

        // ==================== –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø ====================
        function setPartColor(part, color, element) {
            playerColors[part] = color;
            const parentPicker = element.parentNode;
            Array.from(parentPicker.children).forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            updateAllAvatars();
            if (currentUser && !currentUser.isGuest && currentUser.uid) {
                db.collection('users').doc(currentUser.uid).update({ colors: playerColors })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞:', error);
                        if (error.code === 'permission-denied' || error.code === 'unauthenticated' || error.message.includes('permission')) {
                            alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                            logout();
                        }
                    });
            }
        }

        function updateAllAvatars() {
            const avatars = document.querySelectorAll('#sidebar-avatar, #profile-avatar, #customize-avatar');
            avatars.forEach(avatar => {
                avatar.style.backgroundColor = playerColors.body;
                avatar.style.color = 'white';
            });
        }

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¢–†–ê–ù–ò–¶–ê–ú–ò ====================
        function switchPage(page) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const titles = {
                'home': '–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞',
                'profile': '–ü—Ä–æ—Ñ–∏–ª—å',
                'avatar': '–ê–≤–∞—Ç–∞—Ä',
                'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                'friends': '–î—Ä—É–∑—å—è'
            };
            document.getElementById('page-title').textContent = titles[page];
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById(page + '-section').classList.add('active');
        }

        function selectGame() {
            document.querySelector('.game-card-large').classList.add('selected');
        }

        // ==================== –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î (–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†, –ò–ì–†–ê) ‚Äì –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® –ü–û–õ–ù–´–ô –ö–û–î ====================
        // ...
    </script>
</body>
</html>
